<!--缩放，测试完成-->
<!--连接线为贝塞尔曲线,效果不好-->

<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1,maximum-scale=3"/>
    <script src="../d3.v5.min.js"></script>
    <title>指标展示</title>
    <!--
    <script src="https://zhuangnd.github.io/d3//d3.v5.min.js"></script>
--><style>
	body {
		font-family: "Avenir,-apple-system,BlinkMacSystemFont,Segoe UI,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Helvetica Neue,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol";
		}
		
	.rect_cus,.line_time,.circle_time {		
	  fill:mediumaquamarine;
      opacity:0.9;
		cursor: pointer;
	  }
	  
	.line_time {
	  fill:none;
	  stroke:mediumaquamarine;
	  stroke-width:1;
	}	
	
	.selected {
	  fill:coral;
	  }
	
	#lg,#tg,#ig {
		position: absolute;
		padding: 20px;
		background-color: rgba(200,200,200,0.1);
	}
	
	#lg_0 {
		position: absolute;
		top:87px;
		left:50px;
		width: 600px;
		height:250px;		
	}
	#index_flag1 {
		position: absolute;
		top:10px;
		left:50px;
		width: 152px;
		height:20px;
		background-color:mediumaquamarine ;	
		cursor: pointer;
		color:white;
	}
	#lg_1_1 {
		position: absolute;
		top:20px;
		width: 150px;
		height:250px;
		border: thin solid mediumaquamarine;
		color:grey;	
	}
	#index_flag2 {
		position: absolute;
		top:10px;
		left:250px;
		width: 152px;
		height:20px;
		background-color:mediumaquamarine ;	
		cursor: pointer;
		color:white;
	}
	#lg_2_1 {
		position: absolute;
		top:20px;
		width: 150px;
		height:250px;
		border: thin solid mediumaquamarine;
		color:grey;		
	}
	#index_flag3 {
		position: absolute;
		top:10px;
		left:450px;
		width: 152px;
		height:20px;
		background-color:mediumaquamarine ;
		cursor: pointer;
		color:white;	
	}
	#lg_3_1 {
		position: absolute;
		top:20px;
		width: 150px;
		height:250px;
		border: thin solid mediumaquamarine;
		color:grey;		
	}
	
	#tg_0 {
		position: absolute;
		top:500px;
		left:50px;
		width: 600px;
		height:250px;		
	}
	#ig_0 {
		position: absolute;
		top:100px;
		left:750px;
		width: 600px;
		height:650px;		
	}
	
	#lg_table {
		position: absolute;
		top:50px;
		width: 600px;
		height:200px;		
	}
	#lg {
		width: 600px;
		height:250px;
		}
	#tg {	
		width: 600px;
		height:250px;
		}
	#ig {	
		width: 600px;
		height:650px;
		}
		
		.axis path {
			fill: none;
			stroke: none;
			shape-rendering: crispEdges;
		}
		.axis line {
			fill: none;
			stroke: #bbb;
			shape-rendering: crispEdges;
		}
		.axis text {
			fill: #bbb;
			font-family: Arial;
			font-size: 12px;
			shape-rendering: crispEdges;
		}
		
	td {
	width:50px;height:50px;
	}
	
	#tooltip {
				position: absolute;
				width: auto;
				height:auto;
				padding: 10px;
				background-color: rgba(255,255,255,0.85);
				-webkit-border-radius: 10px;
				-moz-border-radius: 10px;
				border-radius: 10px;
				-webkit-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
				-moz-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
				box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
				pointer-events: none;
			}
			
			#tooltip.hidden {
				display: none;
			}
			
			#tooltip p {
				margin: 0;
				font-family: sans-serif;
				font-size: 14px;
				line-height: 18px;
			}
    </style>
</head>

<body>

	<div id="lg_0">
		<div id="lg_text" style="font-size:24px;color:coral"></div>
		<div style="background-color:lightgrey;width:640px;font-size:18px">通关效率指标展示  
		<span id="i_flag" style="background-color:coral;color:white;cursor: pointer;">进口</span>
		<span id="e_flag" style="background-color:mediumaquamarine;color:white;cursor: pointer;">出口</span>
		</div>
	  <div id="lg" >	
		<div class='index_flag' id="index_flag1"  style="text-align:center">报关单量	
			<div class='index_value' id="lg_1_1" style="text-align:center">

          		<p><span id="cus_lg_1" style="font-size:24px"></span><span style="color:#bbb;font-size:12px"> 份</span></p>
          		<p><span style="color:#bbb;font-size:12px">全国 </span><span id="country_lg_1"></span><span style="color:#bbb;font-size:12px"> 份</span></p>
			</div>
		</div>
		
		<div class='index_flag' id="index_flag2"  style="text-align:center">整体通关时间
			<div class='index_value' id="lg_2_1" style="text-align:center">
          		<p><span id="cus_lg_2" style="font-size:24px"></span><span style="color:#bbb;font-size:12px"> 小时</span></p>
          		<p><span style="color:#bbb;font-size:12px">全国 </span><span id="country_lg_2"></span><span style="color:#bbb;font-size:12px"> 小时</span></p>
			</div>
		</div>	
		
		<div class='index_flag' id="index_flag3"  style="text-align:center">海关通关时间	
			<div class='index_value' id="lg_3_1" style="text-align:center">
          		<p><span id="cus_lg_3" style="font-size:24px"></span><span style="color:#bbb;font-size:12px"> 小时</span></p>
          		<p><span style="color:#bbb;font-size:12px">全国 </span><span id="country_lg_3"></span><span style="color:#bbb;font-size:12px"> 小时</span></p>
			</div>
		</div>
	
	  </div>	
	</div>
	
	<div id="tg_0">
		<div id="tg_text" style="font-size:14px;color:dimgrey"></div>
		<div style="background-color:lightgrey;width:640px;font-size:18px">月度趋势</div>
		<div id="tg" >	
		</div>
	</div>
	
	<div id="ig_0">
		<div id="ig_text" style="font-size:14px;color:dimgrey"></div>	
		<div style="background-color:lightgrey;width:640px;font-size:18px">各关排名</div>	
		<div id="ig" >	
		</div>
	</div>
	
	<div id="tooltip" class="hidden">
			<p><span id="tip_time"></span></p>
			<p><span id="tip_value"></span></p>
			<p><span id="tip_order"></span></p>
	</div>
    <script>
    mywidth = 1500;
    height = 850;
    margin = ({top: 100, right: 100, bottom: 100, left: 100});
	var padding = {left:50, right:50, top:20, bottom:20};

	//var indexCode=['entry_id_count','pass_time_total','pass_time_cus','qty','rmb','check_rate','macth_rate','check_discretity','price_index','co_stability'];
	//var indexName=['报关单量','整体通关时间','海关通关时间'];
	var indexName={cus_code: "直属关代码", cus_2_name: "直属关名称", ie: "进出口标志", ym: "年月", entry_id_count: "报关单量",pass_time_cus: "海关通关时间",pass_time_total: "整体通关时间"};
	var ieName={I: "进口", E: "出口"};
	//console.log(indexName.pass_time_cus);

    const parseDate = d3.utcParse("%Y/%m/%d");
	
    //d3.csv("SpZone20191227.csv").then(function(mydata_0){draw(mydata_0);});
	
    d3.csv("sample_tgsj.csv").then(
		function(mydata_0){draw(mydata_0);
		//console.log(mydata_0);
		//console.log(d3.map(mydata_0.filter(d => d.ie == ie_flag && d.ym == "202006"),d => d.cus_2_name).keys());
		//console.log(mydata_0.filter(d => d.ie == ie_flag && d.ym == "202006").map(d => d.cus_2_name));pass_time_cus
		//console.log(mydata_0.filter(d => d.ie == ie_flag && d.cus_code == 0).map(d => d[index_flag]));

		});
		
	function draw(mydata_0) {	
		//const svg = d3.select("body").append("svg")
		//.attr("viewBox", [0, 0, mywidth*1.25, height*1.25]);
  
	var ie_flag = "I",ym_flag = d3.max(mydata_0.filter(d => d.ie == "I" && d.cus_code == 0).map(d => d.ym)),ym_flag1 = ym_flag,cus_flag = "0",index_flag = "pass_time_cus";
	
	const lg = d3.select("#lg").append("svg")
		.attr("width", 600)
		.attr("height", 250).append("g")
		.attr("class","lg")
      .attr("transform", d => `translate(0,0)`);
		  
	const tg = d3.select("#tg").append("svg")
		.attr("width", 600)
		.attr("height", 250).append("g")
		.attr("class","tg")
      .attr("transform", d => `translate(0,0)`);
	  
	const ig = d3.select("#ig").append("svg")
		.attr("width", 600)
		.attr("height", 650)
		.append("g")
		.attr("class","ig")
      .attr("transform", d => `translate(0,0)`);
 

	  
	//指标标签  
	function info_text(){
	d3.select("#lg_text").text(mydata_0.filter(d => d.cus_code == cus_flag)[0].cus_2_name + " " + ym_flag);
	d3.select("#tg_text")
		.text(mydata_0.filter(d => d.ie == ie_flag && d.cus_code == cus_flag)[0].cus_2_name + " " + ieName[ie_flag] + " " + indexName[index_flag]);			
	d3.select("#ig_text")
		.text(ym_flag + "  " + ieName[ie_flag] + " " + indexName[index_flag]);
	d3.select("#cus_lg_0").text(mydata_0.filter(d => d.cus_code == cus_flag)[0].cus_2_name);
	d3.select("#cus_lg_1").text(mydata_0.filter(d => d.ie == ie_flag && d.ym == ym_flag && d.cus_code == cus_flag)[0].entry_id_count);
	d3.select("#cus_lg_2").text(parseFloat(mydata_0.filter(d => d.ie == ie_flag && d.ym == ym_flag && d.cus_code == cus_flag)[0].pass_time_total).toFixed(2));
	d3.select("#cus_lg_3").text(parseFloat(mydata_0.filter(d => d.ie == ie_flag && d.ym == ym_flag && d.cus_code == cus_flag)[0].pass_time_cus).toFixed(2));
	d3.select("#country_lg_1").text(mydata_0.filter(d => d.ie == ie_flag && d.ym == ym_flag && d.cus_code == 0)[0].entry_id_count);
	d3.select("#country_lg_2").text(parseFloat(mydata_0.filter(d => d.ie == ie_flag && d.ym == ym_flag && d.cus_code == 0)[0].pass_time_total).toFixed(2));
	d3.select("#country_lg_3").text(parseFloat(mydata_0.filter(d => d.ie == ie_flag && d.ym == ym_flag && d.cus_code == 0)[0].pass_time_cus).toFixed(2));
	}
	//console.log(indexName.pass_time_cus);
		
	info_text();
	
	d3.select("#i_flag")
		.style("background-color",d => ie_flag=="I"?"coral":"mediumaquamarine")
		.on("click",function(d,i){
		 d3.select(this).style("background-color","coral");		 
		 d3.select("#e_flag").style("background-color","mediumaquamarine");
		 ie_flag = "I";
		 upd_cus(ym_flag);
		 upd_time(cus_flag);
		 });
	d3.select("#e_flag")
		.style("background-color",d => ie_flag=="I"?"mediumaquamarine":"coral")
		.on("click",function(d,i){
		 d3.select(this).style("background-color","coral");		 
		 d3.select("#i_flag").style("background-color","mediumaquamarine");
		 ie_flag = "E";
		 upd_cus(ym_flag);
		 upd_time(cus_flag);
		 });
	
	d3.select("#lg_1_1").style("border",d => index_flag=="entry_id_count"?"thin solid coral":"thin solid mediumaquamarine");	 
	d3.select("#index_flag1")
		.style("background-color",d => index_flag=="entry_id_count"?"coral":"mediumaquamarine")
		.on("click",function(d,i){ 
		 d3.selectAll(".index_flag").style("background-color","mediumaquamarine");
		 d3.select(this).style("background-color","coral");		
		 d3.selectAll(".index_value").style("border","thin solid mediumaquamarine");
		 d3.select("#lg_1_1").style("border","thin solid coral");		
		 index_flag="entry_id_count";
		 upd_cus(ym_flag);
		 upd_time(cus_flag);
		 });
		 
	d3.select("#lg_2_1").style("border",d => index_flag=="pass_time_total"?"thin solid coral":"thin solid mediumaquamarine");
	d3.select("#index_flag2")
		.style("background-color",d => index_flag=="pass_time_total"?"coral":"mediumaquamarine")
		.on("click",function(d,i){
		 d3.selectAll(".index_flag").style("background-color","mediumaquamarine");
		 d3.select(this).style("background-color","coral");	
		 d3.selectAll(".index_value").style("border","thin solid mediumaquamarine");
		 d3.select("#lg_2_1").style("border","thin solid coral");	 
		 index_flag="pass_time_total";
		 upd_cus(ym_flag);
		 upd_time(cus_flag);
		 });
		 
	d3.select("#lg_3_1").style("border",d => index_flag=="pass_time_cus"?"thin solid coral":"thin solid mediumaquamarine");
	d3.select("#index_flag3")
		.style("background-color",d => index_flag=="pass_time_cus"?"coral":"mediumaquamarine")
		.on("click",function(d,i){	 
		 d3.selectAll(".index_flag").style("background-color","mediumaquamarine");
		 d3.select(this).style("background-color","coral");	
		 d3.selectAll(".index_value").style("border","thin solid mediumaquamarine");
		 d3.select("#lg_3_1").style("border","thin solid coral");
		 index_flag="pass_time_cus";
		 upd_cus(ym_flag);
		 upd_time(cus_flag);
		 });
	
	//海关排名	
	x = d3.scaleLinear()
    //.domain(d3.extent(mydata_0, d => parseFloat(d[index_flag])))
    .domain([0,d3.max(mydata_0.filter(d => d.ie == ie_flag && d.ym == ym_flag),d => parseFloat(d[index_flag]))])
    .nice()
    .range([80, 580]);	

	y = d3.scaleBand()
    //.domain(d3.range((mydata_0.filter(d => d.ie == ie_flag && d.ym == "202006").length)))
	//.domain(mydata_0.filter(d => d.ie == ie_flag && d.ym == "202006").map(d => d.cus_2_name))//不排序
	.domain(mydata_0.filter(d => d.ie == ie_flag && d.ym == ym_flag).sort((b,a) => parseFloat(a[index_flag]) - parseFloat(b[index_flag])).map(d => d.cus_2_name))//排序
    .range([620, 20]);
	
	//console.log(mydata_0.filter(d => d.ie == ie_flag && d.ym == "202006").sort((b,a) => parseFloat(a[index_flag]) - parseFloat(b[index_flag])).map(d => d.cus_2_name));
	
	xAxis = g => g
    .attr("transform",d => `translate(0,620)`)
	.attr("class","axis xAxis")
    .call(d3.axisBottom(x).ticks(mywidth / 80).tickSizeOuter(0))
    .call(g => g.select(".domain").remove());

	yAxis = g => g
    .attr("transform", d => `translate(80,0)`)
	.attr("class","axis yAxis")
    .call(d3.axisLeft(y))
    .call(g => g.select(".domain").remove())
    //.call(g => g.select(".tick:last-of-type text").append("tspan").text(mydata.Value))
	;
 
 
	ig.append("g")
      .call(xAxis);

	ig.append("g")
	  .attr("class","yAxis")
      .call(yAxis);
	  
	rect_cus = ig
      .selectAll(".rect_cus")
      .data(mydata_0.filter(d => d.ie == ie_flag && d.ym == ym_flag));
	  //console.log(mydata_0.filter(d => d.ie == ie_flag && d.ym == "202006")[0][index_flag]);
      rect_cus.enter()
      .append("rect")
      .attr("class","rect_cus")
      .attr("id",d => "rect_cus_" + d.cus_code)
      .attr("x",80)
      .attr("y",d => y(d.cus_2_name))
	  .attr("height",10)
	  //.attr("width",0)
	  //.transition()
	  //.duration(1500)
	  .attr("width",d => x(parseFloat(d[index_flag]))-80)
	  .on("click",function(d,i){
         d3.selectAll(".rect_cus").classed("selected",false);
		 d3.select(this).classed("selected",true);
		 upd_time(d.cus_code);
		 cus_flag = d.cus_code;
		 info_text();
		 })		
	  .on("mouseover",function(d,i){			
			//Update the tooltip position and value
			d3.select("#tooltip")
				//.transition()
				//.duration(150)
				.style("left", (d3.event.pageX) + "px")
				.style("top", (d3.event.pageY)-50 + "px")					
				.select("#tip_time")
				.text(d.ym + "  "  + d.cus_2_name);
			d3.select("#tip_value")
				.text(ieName[ie_flag] + " " + indexName[index_flag] + " " + parseFloat(d[index_flag]).toFixed(2));		
			d3.select("#tip_order")
				.text("全国排名 " + (mydata_0.filter(d => d.ie == ie_flag && d.ym == ym_flag && d.cus_code != "0").sort((a,b) => parseFloat(a[index_flag]) - parseFloat(b[index_flag])).map(d => d.cus_code).indexOf(d.cus_code) + 1));				   
			//Show the tooltip
			d3.select("#tooltip").classed("hidden", false)
                .style("opacity",0)
				.transition()
				.duration(750)
                .style("opacity",1);
			   })
		.on("mouseout", function() {
			//Hide the tooltip
			d3.select("#tooltip").classed("hidden", true);
        });
	  
	d3.select("#rect_cus_" + cus_flag)
		.classed("selected",true);  

		

				
	
	//时间序列
	
	x2 = d3.scaleBand()
    //.domain(d3.extent(mydata_0, d => parseFloat(d[index_flag])))
    .domain(mydata_0.filter(d => d.ie == ie_flag && d.cus_code == cus_flag).map(d => d.ym))
    .rangeRound([0, 580]);	

	y2 = d3.scaleLinear()
	.domain([0,d3.max(mydata_0.filter(d => d.ie == ie_flag && d.cus_code == cus_flag),d => parseFloat(d[index_flag]))])
    .nice()
    .range([220, 20]);
	
	line = d3.line()
		.curve(d3.curveCardinal)
		.x(d => x2(d.ym)+mywidth / 2 / mydata_0.filter(d => d.ie == ie_flag && d.cus_code == cus_flag).length - margin.left + 20)
		.y(d => y2(parseFloat(d[index_flag])));
			
	xAxis2 = g => g
    .attr("transform",d => `translate(-5,220)`)
	.attr("class","axis")
    .call(d3.axisBottom(x2).ticks().tickSizeOuter(0))
    .call(g => g.select(".domain").remove());

	yAxis2 = g => g
    .attr("transform", d => `translate(30,0)`)
	.attr("class","axis yAxis2")
    .call(d3.axisLeft(y2))
    .call(g => g.select(".domain").remove())
    //.call(g => g.select(".tick:last-of-type text").append("tspan").text(mydata.Value))
	;
 
 
	tg.append("g")
      .call(xAxis2);

	tg.append("g")
	  .attr("class","yAxis2")
      .call(yAxis2);
	  
	line_time = tg
       .selectAll(".line_time")
       .data(mydata_0.filter(d => d.ie == ie_flag && d.cus_code == cus_flag));
	   //console.log(mydata_0.filter(d => d.ie == ie_flag && d.cus_code == 0));
       line_time.enter()
       .append("path")
       .attr("class","line_time")
       .attr("id",d => "line_time_" + d.ym)
       .attr("d",line(mydata_0.filter(d => d.ie == ie_flag && d.cus_code == cus_flag)));
	   
	circle_time = tg
       .selectAll(".circle_time")
       .data(mydata_0.filter(d => d.ie == ie_flag && d.cus_code == cus_flag));
	   //console.log(mydata_0.filter(d => d.ie == ie_flag && d.cus_code == 0));
       circle_time.enter()
       .append("circle")
       .attr("class","circle_time")
       .attr("id",d => "circle_time_" + d.ym)
       .attr("cx",d => x2(d.ym)+mywidth / 2 / mydata_0.filter(d => d.ie == ie_flag && d.cus_code == cus_flag).length - margin.left + 20)
       .attr("cy",d => y2(parseFloat(d[index_flag])))
       .attr("fill","mediumaquamarine")
	   .attr("r", 5)
	   .on("click",function(d,i){
         d3.selectAll(".circle_time").classed("selected",false);
		 d3.select(this).classed("selected",true);
		 upd_cus(d.ym);
		 ym_flag = d.ym;
		 ym_flag1 = ym_flag;
		 info_text();
		 })
		 .on("mouseover",function(d){			
			ym_flag = d.ym;
			//Update the tooltip position and value
			d3.select("#tooltip")
				//.transition()
				//.duration(150)
				.style("left", (d3.event.pageX) + "px")
				.style("top", (d3.event.pageY)-50 + "px")				
				.select("#tip_time")
				.text((d,i) => ym_flag + "  "  + mydata_0.filter(d => d.cus_code == cus_flag)[0].cus_2_name);	
			d3.select("#tip_value")
				.text(ieName[ie_flag] + " " + indexName[index_flag] + " " + parseFloat(d[index_flag]).toFixed(2));	
			d3.select("#tip_order")
				.text("全国排名 " + (mydata_0.filter(d => d.ie == ie_flag && d.ym == ym_flag && d.cus_code != "0").sort((a,b) => parseFloat(a[index_flag]) - parseFloat(b[index_flag])).map(d => d.cus_code).indexOf(cus_flag) + 1));
			//Show the tooltip
			d3.select("#tooltip").classed("hidden", false)
                .style("opacity",0)
				.transition()
				.duration(750)
                .style("opacity",1);
			   })
		.on("mouseout", function() {
			//Hide the tooltip
			ym_flag = ym_flag1;
			d3.select("#tooltip").classed("hidden", true);
        });
	   
	   d3.select("#circle_time_" + ym_flag)
		.classed("selected",true);
		
		
		
	//时间序列更新
	
	function upd_time(cus_code){
		//console.log(d3.max(mydata_0.filter(d => d.ie == ie_flag && d.cus_code == cus_code),d => parseFloat(d[index_flag])));
		
		y2.domain([0,d3.max(mydata_0.filter(d => d.ie == ie_flag && d.cus_code == cus_code),d => parseFloat(d[index_flag]))]).nice();


		d3.select(".yAxis2")
			.transition()
			.duration(1200)
			.call(yAxis2);
		
		d3.selectAll(".line_time")
			.transition()
			.duration(1200)
			.attr("d",line(mydata_0.filter(d => d.ie == ie_flag && d.cus_code == cus_code)));
			
        d3.selectAll(".circle_time")
			.transition()
			.duration(1200)
			.attr("cy",(d,i) => y2(parseFloat(mydata_0.filter(d => d.ie == ie_flag && d.cus_code == cus_code)[i][index_flag])));
			
		info_text();

		}
		
			
	//排名更新
		function upd_cus(ym){
		//console.log(d3.max(mydata_0.filter(d => d.ie == ie_flag && d.cus_code == cus_code),d => parseFloat(d[index_flag])));
		
		x.domain([0,d3.max(mydata_0.filter(d => d.ie == ie_flag && d.ym == ym),d => parseFloat(d[index_flag]))]).nice();
		y.domain(mydata_0.filter(d => d.ie == ie_flag && d.ym == ym).sort((b,a) => parseFloat(a[index_flag]) - parseFloat(b[index_flag])).map(d => d.cus_2_name))

		d3.select(".xAxis")
			.transition()
			.duration(1200)
			.call(xAxis);
		d3.select(".yAxis")
			.transition()
			.duration(1200)
			.call(yAxis);
		
		d3.selectAll(".rect_cus")
			.transition()
			.duration(1200)
			.attr("y",d => y(d.cus_2_name))
			.attr("width",(d,i) => x(parseFloat(mydata_0.filter(d => d.ie == ie_flag && d.ym == ym)[i][index_flag]))-80);	
			
		info_text();
	
		}
		
		}
	
    </script>
    
</body>

</html>
