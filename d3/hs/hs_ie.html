<!DOCTYPE html>
<!--

  
-->
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width" />
    <title>hs</title>
    <script type="text/javascript" src="../js/d3.v7.min.js"></script>
    <script type="text/javascript" src="legend.js"></script>

    <style>
        #chart,#worldmap,#cnmap {
          flex: 1;
          margin-top: 2px;
          position: absolute; 
          left:0px;
          background-color: #f5f5f5; 
          padding: 0px; 
          border: 8px solid white;
        }
        #worldmap {
          top:450px;
          left:908px;
          opacity:1;
        }
        #cnmap {
          left:908px;
          opacity:1;
        }
        #tooltip {
          white-space: initial;
          flex: 0.1;
          position: absolute;
          width:400px;
          top:400px;
          left:300px;
          background-color: #f0f0f0;
          border: 1px solid #d5d5d5;
          padding: 10px 5px 0px 10px;
          color: #78909c;
          font-size: 12px;
          display:null; 
        }
        #legend {
          position: absolute;
          top:750px;
          left:70px;
          font-size:12px;
          width:auto;
          
        }
        .axis path  {
            stroke: none;
        }
        .axis line  {
            stroke: #aaa;
        }
        .axis text  {
            fill: #aaa;
        }
        .legend line {
          stroke: #ddd;
        }
        .legend text  {
            fill: #78909c;
            font-weight: 300;
            font-size:12px;
        }
        .legend :hover {
          cursor:pointer;
        }
        path {
            stroke: #aaa;
            stroke-width: .5px;
        }
        .lg_x-axis line, .lg_x-axis path { stroke: #ddd; }
        .cells {
          stroke:none;
        }
        .checked  { 
          stroke: #af7aa1;
          stroke-width:1px;
         }
        .unhover {
           opacity: 0.3;
         }

    </style>
</head>

<body>

  <div style="width: 1408px;font-family: sans-serif;">
    <div style = "background-color: #E4E5E6; padding: 20px; color: #78909c; position: relative;"> 
      <text style = "font-size: 24px; line-height:1"> <span style = "font-weight: bold">HS</span>商品编码及进出口 <span style = "font-size:12px; color: #aaa";><a style = " font-size: 13px; font-weight: 300; color: #78909c" href="mailto:zhuangnd@me.com">By @zhuangnd</a>（数据来源：海关总署网站 2022年1-9月）</span></text>
    </div>
 
   <div id = "chart">
   </div>
   <div id = "worldmap">
   </div>
   <div id = "cnmap">
   </div>
   
   <div id = "legend">
   </div> 
   <div id = "tooltip">
       <span id = "tip_title"></span><br>
       <span id = "tip_subtitle"></span><br> 
       <span id = "tip_info"></span><br>
       <span id = "tip_top_hs"></span><br>
       <span id = "tip_top_area"></span><br>
        
   </div>
  </div>
<script type="text/javascript">
    var width = 900, height = 750;
    var margin = ({top: 50, right: 50, bottom: 50, left: 50})
    var tooltip = d3.select("#tooltip");
    var map_info = d3.select("#map_info");
  
    

    d3.csv("hs4.csv").then(
		  function(data){
        hs4_data = data.map(({hs2_code,hs2_name,hs4_code,hs4_name,hs8_count,i,e,ie})=>({hs2_code,hs2_name,hs4_code,hs4_name,hs8_count,i:parseFloat(i),e:parseFloat(e),ie:parseFloat(ie)}));
        hs4_grp=d3.group(hs4_data,d=>d.hs4_code);
    d3.csv("country.csv").then(
      function(data){
        country_data = data.map(({hs_code,country_name,ISO_N3,i,e,ie})=>({hs_code,country_name,ISO_N3,i:parseFloat(i),e:parseFloat(e),ie:parseFloat(ie)}));
        cnty_id_grp=d3.group(country_data,d=>d.ISO_N3);
        cnty_hs_grp=d3.group(country_data,d=>d.hs_code);
        cnty_grp=d3.group(country_data,d=>d.ISO_N3,d=>d.hs_code);
        cnty_tmp=d3.groups(country_data,d=>d.ISO_N3).flatMap(([ISO_N3,cdata])=>({ISO_N3,i:d3.max(cdata.filter(e=>e.hs_code>0).map(f=>f.i)),e:d3.max(cdata.filter(e=>e.hs_code>0).map(f=>f.e)),ie:d3.max(cdata.filter(e=>e.hs_code>0).map(f=>f.ie))}));
        cnty_hs4_max=d3.group(cnty_tmp,d=>d.ISO_N3);
        cnty_hs4_count=d3.group(d3.groups(country_data,d=>d.ISO_N3).flatMap(([ISO_N3,cdata])=>({ISO_N3,hs4_count:cdata.length})),e=>e.ISO_N3);
        cnty_hs4_count_range=d3.extent(d3.groups(country_data,d=>d.ISO_N3).flatMap(([ISO_N3,cdata])=>({ISO_N3,hs4_count:cdata.length})).filter(d=>d.ISO_N3!='999'),d=>d.hs4_count);
        //cnty_hs4_max=d3.group(country_data.filter(d=>d.hs_code>0),d=>d.ISO_N3);//每个国家hs4最大值，未完成 [{id:840,i:45}]
        
        //d3.groups(country_data,d=>d.ISO_N3).flatMap(([ISO_N3,cdata])=>({ISO_N3,i:d3.max(cdata.filter(e=>e.hs_code>0).map(f=>f.i))}))
        //d3.groups(country_data,d=>d.ISO_N3).flatMap(([ISO_N3,cdata])=>({ISO_N3,i:cdata}))
        
        //d3.max(d3.group(country_data.filter(d=>d.hs_code>0),d=>d.ISO_N3).get('840').map(e=>e.i))
        
        //cnty_id_grp.map(([y,data])=>{i=d3.max(data.map(e=>e.i));return data.map(y=>({y,imax:i}))})
        //cnty_grp.get(ISO_N3).get(hs_code)
        //d3.groupSort(country_data,g=>-d3.sum(g,d=>parseFloat(d.ie)),d=>d.country_name) //得出按进出口值倒序的国家 Array:[美国，韩国，日本...]
        //d3.groupSort(cnty_id_grp.get('156'),g=>-d3.sum(g,d=>parseFloat(d.ie)),d=>d.hs_code)
    d3.csv("provinces.csv").then(
      function(data){
        province_data = data.map(({hs_code,province_code,province_name,i,e,ie})=>({hs_code,province_code,province_name,i:parseFloat(i),e:parseFloat(e),ie:parseFloat(ie)}));//.filter(d=>d.hs_code==0 || d.hs_code > 100).filter(d=>d.hs_code<1000); 
        pr_id_grp=d3.group(province_data,d=>d.province_code);
        pr_hs_grp=d3.group(province_data,d=>d.hs_code);
        pr_grp=d3.group(province_data,d=>d.province_code,d=>d.hs_code);
        pr_tmp=d3.groups(province_data,d=>d.province_code).flatMap(([province_code,cdata])=>({province_code,i:d3.max(cdata.filter(e=>e.hs_code>0).map(f=>f.i)),e:d3.max(cdata.filter(e=>e.hs_code>0).map(f=>f.e)),ie:d3.max(cdata.filter(e=>e.hs_code>0).map(f=>f.ie))}));
        pr_hs4_max=d3.group(pr_tmp,d=>d.province_code);
        pr_hs4_count=d3.group(d3.groups(province_data,d=>d.province_code).flatMap(([province_code,cdata])=>({province_code,hs4_count:cdata.length})),e=>e.province_code);
        pr_hs4_count_range=d3.extent(d3.groups(province_data,d=>d.province_code).flatMap(([province_code,cdata])=>({province_code,hs4_count:cdata.length})),d=>d.hs4_count);
        
        //pr_grp.get(ISO_N3).get(hs_code)
        //cpr_grp.get('35').get(d3.groupSort(pr_id_grp.get('35'),g=>-d3.sum(g,d=>d.ie),d=>d.hs_code).slice(1,2)[0])[0].ie//取福建省进出口最大的hs进出口值
    d3.csv("province_country.csv").then(
      function(data){
        pr_cnty = data.map(({ISO_N3,country_name,province_code,province_name,e,i,ie})=>({ISO_N3,country_name,province_code,province_name,i:parseFloat(i),e:parseFloat(e),ie:parseFloat(ie)}));//.filter(d=>d.hs_code==0 || d.hs_code > 100).filter(d=>d.hs_code<1000); 
        p_c_pgrp=d3.group(pr_cnty,d=>d.province_code);
        p_c_cgrp=d3.group(pr_cnty,d=>d.ISO_N3);
        p_c_grp=d3.group(pr_cnty,d=>d.province_code,d=>d.ISO_N3);
        //p_c_grp.get(ISO_N3).get(ISO_N3)
        
    d3.json("world_605kb.json").then(
      function(data){
        map_w_data=data.features;
    d3.json("china.json").then(
      function(data){
        map_cn_data=data.features;
        

        
      //参数初始化    
        var is_clicked=0;  
        var last_c='n',checked=-1;
        var flag_set = {hs:'HS8编码',ie:'进出口',i:'进口',e:'出口'}
        //var lg_title={hs:'HS8数量',ie:'HS4进出口(亿元)',i:'HS4进口(亿元)',e:'HS4出口(亿元)'};
        var flag ='hs';//0:export,1:import,2:hs_count
        var color_range={hs:["white","#e5e5e5","#8d8882","#222"],hs_m:["white","#f0f5f9","#ddf2e5","#536976"],ie:["white","#e0edd4","#59a14f","#38571a"],i:[ "white","#caf0fe","#008cb4","#00364a"],e:[ "white","#ffdad8","#ff4013","#5c0700"]};
        //var color_range2={hs:{color:["white","#ddd","#999","#333"],title:'HS8编码(个)'},ie:{color:["white","#e0edd4","#59a14f","#38571a"],title:'HS4进出口(亿元)'},i:{color:[ "white","#caf0fe","#008cb4","#00364a"],title:'HS4进口(亿元)'},e:{color:[ "white","#ffdad8","#ff4013","#5c0700"],title:'HS4出口(亿元)'}};
        var legend_data=[{flag:'hs',title:'HS8编码(个)'},{flag:'ie',title:'HS4进出口(亿元)'},{flag:'i',title:'HS4进口(亿元)'},{flag:'e',title:'HS4出口(亿元)'}];
        var domain_max = {hs:169,ie:d3.max(hs4_data.map(d=>(d.ie))),i:d3.max(hs4_data.map(d=>(d.i))),e:d3.max(hs4_data.map(d=>(d.e)))};
        
        color_map=(flag,max,x)=>d3.scaleSqrt([0,1,max/2, max], color_range[flag])(x);
        colorScale=(domain,flag)=>d3.scaleSqrt(domain, color_range[flag]);
        linearGradient_data=(domain,flag)=>d3.scaleSqrt(domain, color_range[flag]).ticks().map((t, i, n) => ({ offset: `${100*i/n.length}%`, color: d3.scaleSqrt(domain, color_range[flag])(t) }));
       

      
      //draw chart
        var svg = d3.select("#chart").append("svg")
            .attr("width", width)
            .attr("height", height)
            .attr("viewBox", "0 0 " + (width) + " " + (height));

        x = d3.scaleLinear()
          .domain([1,100])
          .range([margin.left, width - margin.right]);
        y = d3.scaleLinear()
          .domain([1,85])
          .range([margin.top, height - margin.bottom]);  
           
        xAxis = svg.append("g")
          .attr("class","x axis")
          .attr("transform", `translate(${height/200-1},${margin.top-height/100})`)
          .call(d3.axisTop(x).ticks(10).tickSizeOuter(0))
          .append("text")
          .text("HS1-2 ⇢")
          .attr("transform", `translate(${margin.left+20},0)`);

        yAxis = svg.append("g")
          .attr("class","y axis")
          .attr("transform", `translate(${margin.left},${height/200-1})`)
          .call(d3.axisLeft(y).ticks(10).tickSizeOuter(0))
            .append("text")
            .text("HS3-4 ⇣")
            .attr("transform", `translate(-5,${margin.top+15})`);
            
        cells = svg.append("g")
          .selectAll("rect")
          //.data(hs_data)
          .data(hs4_data)
          .enter()
          .append("rect")
          .attr("class","cells")
          .attr("height",height/100-2)
          .attr("width", width/100-2)
          .attr("id",d=>`b${d.hs4_code}`);
            
        cells.attr("fill",(d,i)=>color_map('hs',169,hs4_data.filter(e=>e.hs2_code==d.hs2_code).length))
          .attr("x",d => x(d.hs2_code))
          .attr("y",margin.top)
          .transition()
          .delay(d=>y(d.hs4_code%100)*2)
          .duration(300)
          .attr("y",d => y(d.hs4_code%100))
          .attr("fill",d=>color_map('hs',169,d.hs8_count));
           
      //draw world map
        var proj = d3.geoMercator().center([0, 40]).scale(70).translate([(1400-width) / 2, height / 4+30]);
        var path = d3.geoPath().projection(proj);
        
        var map_w_svg = d3.select("#worldmap")
          .append("svg")
          .attr("id","w_map_g")
          .attr("width", 1400-width)
          .attr("height", height/2-2)
          .attr("transform", `translate(0,0)`)
          .attr("viewBox", "0 0 " + (1400-width) + " " + height/2);
        
        var country = map_w_svg.append("g")
          .selectAll("path")
          .data(map_w_data)
          .enter()
          .append("path")
          .attr("d", path)
          .attr("fill","#dddddd")
          .attr("class", "countries")
          .attr("id",d=>`w${d.properties.ISO_N3}`);
                
      //draw china map
        var proj_cn = d3.geoMercator().center([105, 38]).scale(400).translate([(1400-width) / 2, height / 4]);
        var path_cn = d3.geoPath().projection(proj_cn);
        
        var map_cn_svg = d3.select("#cnmap")
          .append("svg")
          .attr("id","cn_map_g")
          .attr("width", 1400-width)
          .attr("height", height/2-3)
          .attr("transform", `translate(0,0)`)
          .attr("viewBox", "0 0 " + (1400-width) + " " + height/2);
        
        var province = map_cn_svg.append("g")
          .selectAll("path")
          .data(map_cn_data)
          .enter()
          .append("path")
          .attr("d", path_cn)
          .attr("fill","#dddddd")
          .attr("class", "provinces")
          .attr("id",d=>`c${d.properties.id}`);

      //legend group
        var lg_width = 160,lg_height = 70,lg_barHeight = 8;
        var lg_margin = ({top: 30, right: 40, bottom: 30, left: 20});
        
        function lg_axisScale(domain) {return d3.scaleLinear()
          .domain(domain)
          //.domain(colorScale.domain())
          .range([lg_margin.left, lg_width - lg_margin.right])}
        
        function lg_axisBottom(domain) {return g=>g
          .attr("class", `lg_x-axis`)
          .attr("transform", `translate(0,${lg_height - lg_margin.bottom})`)
          .call(d3.axisBottom(lg_axisScale(domain))
          .ticks(1.5)
          .tickSize(-lg_barHeight))}
        
        /*
        const lg_button = d3.select("#legend").selectAll(".legend")
          .data(legend_data)
          .enter()
          .append('button');
        */  
        const lg_svg=d3.select("#legend").selectAll(".legend")
          .data(legend_data)
          .enter()
          //.append('div')
          .append("svg")//lg_svg=lg_button.append("svg")
          .attr('class','legend')
          .attr('id',(d,i)=>`${d.flag}_legend`)
          .attr("width",lg_width).attr("height", lg_height);
          lg_svg.on("click",function(e,dd){//lg_button.on
            flag = dd.flag;
            fill_map_w(dd.flag,0);
            fill_map_cn(dd.flag,0);
            //flag=='hs'?fill_map_w('ie',0):fill_map_w(dd.flag,0);
            //flag=='hs'?fill_map_w('ie',0):fill_map_cn(dd.flag,0);
            /*
            d3.selectAll('#worldmap,#cnmap')
              .transition()
              .duration(1500)
              .style('opacity',1);
            */
            fill_cell(flag,flag,0);
            tooltip_display(null,null,flag,null);
            //last_c='n';
          })  
        
        const linearGradient = lg_svg.append("defs").append("linearGradient")
            .attr("id", (d,i)=>`${d.flag}_linear-gradient`);
            
        linearGradient.selectAll("stop")
          .data(colorScale([0,1,domain_max[flag]/2,domain_max[flag]],flag).ticks().map((t, i, n) => ({ offset: `${100*i/n.length}%`, color: colorScale([0,1,domain_max[flag]/2,domain_max[flag]],flag)(t) })))//----2
          .enter().append("stop")
          .attr("offset", d => d.offset)
          .attr("stop-color", d => d.color);
        
        lg_rect=lg_svg.append('g')
          .attr("transform", `translate(0,${lg_height - lg_margin.bottom - lg_barHeight})`)
          .append("rect")
          .attr("id", (d,i)=>`${d.flag}_rect`)
          .attr('transform', `translate(${lg_margin.left}, 0)`)
          .attr("width", lg_width - lg_margin.right - lg_margin.left)
          .attr("height", lg_barHeight)
          .style("fill", (d,i)=>`url(#${d.flag}_linear-gradient)`);
        
        lg_axis=lg_svg.append('g')
          .attr("id", (d,i)=>`${d.flag}_lg_axis`)
          .call(lg_axisBottom([0,domain_max.hs]));
        lg_text=lg_svg.append('text')
          .attr('transform', `translate(${lg_margin.left},${lg_margin.top-3})`)
          .text(d=>d.title);//----4
          
      //update legend
        hs_colorScale = d3.scaleSqrt([0,1,85, 169], color_range.hs);
        d3.select("#hs_linear-gradient").selectAll("stop").remove();
        d3.select("#hs_linear-gradient")
          .selectAll("stop")
          .data(hs_colorScale.ticks().map((t, i, n) => ({ offset: `${100*i/n.length}%`, color: hs_colorScale(t) })))//2
          .enter().append("stop")
          .attr("offset", d => d.offset)
          .attr("stop-color", d => d.color);
        d3.select("#hs_lg_axis").call(lg_axisBottom(([0,domain_max.hs])));  
        
        ie_colorScale = d3.scaleSqrt([0,1,domain_max.ie/2, domain_max.ie], color_range.ie);
        d3.select("#ie_linear-gradient").selectAll("stop").remove();
        d3.select("#ie_linear-gradient")
          .selectAll("stop")
          .data(ie_colorScale.ticks().map((t, i, n) => ({ offset: `${100*i/n.length}%`, color: ie_colorScale(t) })))//2
          .enter().append("stop")
          .attr("offset", d => d.offset)
          .attr("stop-color", d => d.color);
        d3.select("#ie_lg_axis").call(lg_axisBottom(([0,domain_max.ie/100000000])));  
        
        i_colorScale = d3.scaleSqrt([0,1,domain_max.i/2, domain_max.i], color_range.i);
        d3.select("#i_linear-gradient").selectAll("stop").remove();
        d3.select("#i_linear-gradient")
          .selectAll("stop")
          .data(i_colorScale.ticks().map((t, i, n) => ({ offset: `${100*i/n.length}%`, color: i_colorScale(t) })))//2
          .enter().append("stop")
          .attr("offset", d => d.offset)
          .attr("stop-color", d => d.color);
        d3.select("#i_lg_axis").call(lg_axisBottom(([0,domain_max.i/100000000])));  
        
        e_colorScale = d3.scaleSqrt([0,1,domain_max.e/2, domain_max.e], color_range.e);
        d3.select("#e_linear-gradient").selectAll("stop").remove();
        d3.select("#e_linear-gradient")
          .selectAll("stop")
          .data(e_colorScale.ticks().map((t, i, n) => ({ offset: `${100*i/n.length}%`, color: e_colorScale(t) })))//2
          .enter().append("stop")
          .attr("offset", d => d.offset)
          .attr("stop-color", d => d.color);
        d3.select("#e_lg_axis").call(lg_axisBottom(([0,domain_max.e/100000000]))); 
        
      
      // map legend
        const lg_w = d3.select("#w_map_g")
          .append("svg")
          .attr('class','legend')
          .attr('id','w_legend')
          .attr("width",lg_width).attr("height", lg_height);
        const w_linearGradient = lg_w.append("defs").append("linearGradient")
            .attr("id", 'w_linear-gradient');
        w_linearGradient.selectAll("stop")
          .data(colorScale([0,1,domain_max[flag]/2,domain_max[flag]],flag).ticks().map((t, i, n) => ({ offset: `${100*i/n.length}%`, color: colorScale([0,1,domain_max[flag]/2,domain_max[flag]],flag)(t) })))//----2
          .enter()
          .append("stop")
          .attr("offset", d => d.offset)
          .attr("stop-color", d => d.color);
        w_lg_rect=lg_w.append('g')
          .attr("transform", `translate(0,${lg_height - lg_margin.bottom - lg_barHeight})`)
          .append("rect")
          .attr("id", 'w_rect')
          .attr('transform', `translate(${lg_margin.left}, 0)`)
          .attr("width", lg_width - lg_margin.right - lg_margin.left)
          .attr("height", lg_barHeight)
          .style("fill", 'url(#w_linear-gradient)');
        w_lg_axis=lg_w.append('g')
          .attr("id", "w_lg_axis")
          .call(lg_axisBottom(([0,flag=='hs'?d3.max(country_data.map(d=>(d.ie)))/100000000:d3.max(country_data.filter(d=>d.hs_code>100).map(d=>(d.ie)))/100000000])));//----3
        w_lg_text=lg_w.append('text')
          .attr('transform', `translate(${lg_margin.left},${lg_margin.top-3})`)
          .text('进出口(亿元)');//----4
        
        const lg_cn = d3.select("#cn_map_g")
          .append("svg")
          .attr('class','legend')
          .attr('id','cn_legend')
          .attr("width",lg_width).attr("height", lg_height);
        const cn_linearGradient = lg_cn.append("defs").append("linearGradient")
            .attr("id", 'cn_linear-gradient');
        cn_linearGradient.selectAll("stop")
          .data(colorScale([0,1,domain_max[flag]/2,domain_max[flag]],flag).ticks().map((t, i, n) => ({ offset: `${100*i/n.length}%`, color: colorScale([0,1,domain_max[flag]/2,domain_max[flag]],flag)(t) })))//----2
          .enter()
          .append("stop")
          .attr("offset", d => d.offset)
          .attr("stop-color", d => d.color);
        cn_lg_rect=lg_cn.append('g')
          .attr("transform", `translate(0,${lg_height - lg_margin.bottom - lg_barHeight})`)
          .append("rect")
          .attr("id", 'cn_rect')
          .attr('transform', `translate(${lg_margin.left}, 0)`)
          .attr("width", lg_width - lg_margin.right - lg_margin.left)
          .attr("height", lg_barHeight)
          .style("fill", 'url(#cn_linear-gradient)');
        cn_lg_axis=lg_cn.append('g')
          .attr("id", "cn_lg_axis")
          .call(lg_axisBottom(([0,flag=='hs'?d3.max(province_data.map(d=>(d.ie)))/100000000:d3.max(province_data.filter(d=>d.hs_code>100).map(d=>(d.ie)))/100000000])));//----3
                cn_lg_text=lg_cn.append('text')
          .attr('transform', `translate(${lg_margin.left},${lg_margin.top-3})`)
          .text('进出口(亿元)');//----4  
      

      //interactive , 
        var tooltip = d3.select("#tooltip"); 
        var tip_title = d3.select("#tip_title");
        var tip_subtitle = d3.select("#tip_subtitle");
        var tip_info = d3.select("#tip_info");
        
        cells.on("mouseenter touchstart",function (e,d){
            var d1=new Date();
            var t1=d1.getTime();
            
            d3.selectAll(".cells").classed('unhover',true);
            d3.select(this).classed('unhover',false);
            
            last_c.slice(0,1)!='n' || flag=='hs'?null:fill_map_w(flag, d.hs4_code);
            last_c.slice(0,1)!='n' || flag=='hs'?null:fill_map_cn(flag,d.hs4_code);
            tooltip_display('cell',last_c,flag,d);
            
            var d2=new Date();
            var t2=d2.getTime();
            console.log(t2-t1)
            
          })  
          .on("mouseleave touchmove",function (e,d) {
            d3.selectAll(".cells").classed('unhover',last_c.slice(0,1)=='b'?true:false);
            d3.select(`#${last_c}`).classed('unhover',false);
            
            last_c.slice(0,1)!='n' || flag=='hs'?null:fill_map_w(flag, 0);
            last_c.slice(0,1)!='n' || flag=='hs'?null:fill_map_cn(flag, 0);
            tooltip_display_c(last_c, flag);
            //tooltip.style("display","none");
            //last_c.slice(0,1)=='n'?tooltip.style("display","none"):tooltip_display('cell',last_c,flag,d);
          })
          .on("click",function (e,d) {
            flag=='hs'?null:last_c=last_c=='n'?`b${d.hs4_code}`:last_c==`b${d.hs4_code}`?'n':last_c;
            d3.select(this).classed('checked',last_c.slice(1)==d.hs4_code?true:false);
          });  
          
        province.on("mouseenter touchstart", function (e,d) {  
            var d1=new Date();
            var t1=d1.getTime();

            d3.selectAll(".provinces").classed('unhover',true);
            d3.select(this).classed('unhover',false);
            
            last_c.slice(0,1)=='w' || last_c.slice(0,1)=='c' || flag=='hs'?null:fill_cell('cn',flag,d.properties.id);
            last_c.slice(0,1)=='n'?fill_map_w(flag,0,d.properties.id):null ;
            tooltip_display('m_cn',last_c,flag,d);
            
            var d2=new Date();
            var t2=d2.getTime();
            console.log(t2-t1)
          })
          .on("mouseleave touchmove",function (e,d) {
            d3.selectAll(".provinces").classed('unhover',last_c.slice(0,1)=='c'?true:false);
            d3.select(`#${last_c}`).classed('unhover',false);
            
            last_c.slice(0,1)=='w' || last_c.slice(0,1)=='c' || flag=='hs'?null:fill_cell('mso',flag,0);
            last_c.slice(0,1)=='n'?fill_map_w(flag,0,0):null;
            tooltip_display_c(last_c, flag);//tooltip.style("display",'none')
          })
          .on("click",function (e,d) {
              flag=='hs'?null:last_c=last_c=='n'?`c${d.properties.id}`:last_c==`c${d.properties.id}`?'n':last_c;
              d3.select(this).classed('checked',last_c.slice(1)==d.properties.id?true:false);
          });
        
        country.on("mouseenter touchstart", function (e,d) { 
            var d1=new Date();
            var t1=d1.getTime();

            //d3.selectAll(".countries").style("opacity",0.3);
            //d3.select(this).style("opacity",1);
            d3.selectAll(".countries").classed('unhover',true);
            d3.select(this).classed('unhover',false);
            
            last_c.slice(0,1)=='w' || last_c.slice(0,1)=='c' || flag=='hs'?null:fill_cell('w',flag,d.properties.ISO_N3);
            last_c.slice(0,1)=='n'?fill_map_cn(flag,0,d.properties.ISO_N3):null ;
            tooltip_display('m_w',last_c,flag,d);
            
            var d2=new Date();
            var t2=d2.getTime();
            console.log(t2-t1)
            
          })
          .on("mouseleave touchmove",function (e,d) {
            //d3.selectAll(".countries").style("opacity",last_c.slice(0,1)=='w'?0.3:1);
            //d3.select(this).style("opacity",last_c.slice(0,1)=='w'?1);
            d3.selectAll(".countries").classed('unhover',last_c.slice(0,1)=='w'?true:false);
            d3.select(`#${last_c}`).classed('unhover',false);
            
            last_c.slice(0,1)=='w' || last_c.slice(0,1)=='c' || flag=='hs'?null:fill_cell('mso',flag,0);
            last_c.slice(0,1)=='n'?fill_map_cn(flag,0,0):null;
            tooltip_display_c(last_c, flag);//tooltip.style("display",'none')
          })
          .on("click",function (e,d) {
              flag=='hs'?null:last_c=last_c=='n'?`w${d.properties.ISO_N3}`:last_c==`w${d.properties.ISO_N3}`?'n':last_c;
              d3.select(this).classed('checked',last_c.slice(1)==d.properties.ISO_N3?true:false);

          }); 
         
        
      //chart&map update
      
        fill_map_w(flag,0,0);
        fill_map_cn(flag,0,0);
        tooltip_display(null,null,flag,null);
        
        //世界地图更新，性能暂时未显著受filter影响，暂不修改        
        function fill_map_w(flag,hs,id) {
          //console.log(flag,hs,id);
          country.attr("fill",dd=>{
              //flag=flag=='hs'?'ie':flag;
              id=id?id:0;
              hs=hs?hs:0;
              data=flag=='hs'?cnty_hs4_count:id==0?cnty_hs_grp.get(hs.toString()):p_c_pgrp.get(id);
              //console.log(data);
              //v_max = flag=='hs'?cnty_hs4_count_range[1]:data?d3.max(data.map(e=>(e[flag]))):0;
              v_max = flag=='hs'?1234:data?d3.max(data.map(e=>(e[flag]))):0;
              //v_max = d3.max(country_data.filter(d=>d.hs_code==hs).map(e=>(e[flag])));
              return flag=='hs'?cnty_hs4_count.get(dd.properties.ISO_N3)?color_map('hs_m',v_max,cnty_hs4_count.get(dd.properties.ISO_N3)[0].hs4_count):'#f5f5f5':data?data.filter(el=>el.ISO_N3==(dd.properties.ISO_N3)).length>0?data.filter(e=>(e.ISO_N3)==(dd.properties.ISO_N3))[0][flag]>0?color_map(flag,v_max,data.filter(e=>(e.ISO_N3)==(dd.properties.ISO_N3))[0][flag]):"#dddddd":"#dddddd":"#dddddd";
            });
            w_linearGradient.selectAll("stop").remove();
            w_linearGradient.selectAll("stop")
              .data(linearGradient_data([0,1,v_max/2,v_max],flag=='hs'?'hs_m':flag))//----2
              .enter()
              .append("stop")
              .attr("offset", d => d.offset)
              .attr("stop-color", d => d.color);
            w_lg_axis.call(lg_axisBottom([0,flag=='hs'?v_max:v_max/100000000]));//----3
            w_lg_text.text(d=>flag=='hs'?'进出口HS4编码(个)':legend_data.filter(e=>e.flag==flag)[0].title.slice(3));//:legend_data.filter(e=>e.flag==flag)[0].title);//----4
        };

        //中国地图更新 ，性能暂时未显著受filter影响，暂不修改
        function fill_map_cn(flag,hs,id) {
          //console.log(flag,hs,id);
          province.attr("fill",dd=>{
            //flag=flag=='hs'?'ie':flag;
            id=id?id:0;
            hs=hs?hs:0;
            data=flag=='hs'?pr_hs4_count:id==0?pr_hs_grp.get(hs.toString()):p_c_cgrp.get(id);
            v_max = flag=='hs'?1234:data?d3.max(data.map(e=>e[flag])):0;
            return flag=='hs'?pr_hs4_count.get(dd.properties.id)?color_map('hs_m',v_max,pr_hs4_count.get(dd.properties.id)[0].hs4_count):'#f5f5f5':data?data.filter(el=>el.province_code==(dd.properties.id)).length>0?data.filter(e=>(e.province_code)==(dd.properties.id))[0][flag]>0?color_map(flag,v_max,data.filter(e=>(e.province_code)==(dd.properties.id))[0][flag]):"#dddddd":"#dddddd":"#dddddd";
          });
          cn_linearGradient.selectAll("stop").remove();
          cn_linearGradient.selectAll("stop")
            .data(linearGradient_data([0,1,v_max/2,v_max],flag=='hs'?'hs_m':flag))//----2
            .enter()
            .append("stop")
            .attr("offset", d => d.offset)
            .attr("stop-color", d => d.color);
          cn_lg_axis.call(lg_axisBottom([0,flag=='hs'?v_max:v_max/100000000]));//----3
          cn_lg_text.text(d=>flag=='hs'?'进出口HS4编码(个)':legend_data.filter(e=>e.flag==flag)[0].title.slice(3));//----4    
        };  

        //地图鼠标事件主图更新          
        function fill_cell(s,flag,id) {
          switch (s) {
            case 'cn': cells.attr("fill",dd=>{
              //data = pr_id_grp.get(id);
              //is_hs = data.filter(el=>el.hs_code==dd.hs4_code).length;
              //m = d3.max(data.slice(1).map(f=>(f[flag])))//slice(1),过滤掉hs2
              //return is_hs>0?data.filter(el=>el.hs_code==dd.hs4_code)[0][flag]>0?color_map(flag,m,data.filter(el=>el.hs_code==dd.hs4_code)[0][flag]):"#dddddd":"#dddddd";
              is_hs=pr_grp.get(id).get(dd.hs4_code)?1:0;
              m=pr_hs4_max.get(id)[0][flag]
              return is_hs==1?pr_grp.get(id).get(dd.hs4_code)[0][flag]>0?color_map(flag,m,pr_grp.get(id).get(dd.hs4_code)[0][flag]):"#dddddd":"#dddddd";
              
            }); 
            //legend
            d3.select(`#${flag}_linear-gradient`).selectAll("stop").remove();
            d3.select(`#${flag}_linear-gradient`).selectAll("stop")
              .data(linearGradient_data([0,1,m/2,m],flag))//----2
              .enter()
              .append("stop")
              .attr("offset", d => d.offset)
              .attr("stop-color", d => d.color);
            d3.select(`#${flag}_lg_axis`).call(lg_axisBottom([0,m/100000000]));//----3
            break;
            
            case 'w': cells.attr("fill",dd=>{
              //data = cnty_id_grp.get(id);
              
              //以下3行极大影响效率
              is_hs=cnty_grp.get(id).get(dd.hs4_code)?1:0;
              //is_hs=data.filter(el=>el.hs_code==dd.hs4_code).length;
              m=cnty_hs4_max.get(id)[0][flag]
              //m=d3.max(data.slice(1).map(f=>(f[flag])))//提前计算各国hs4进出口最大值
              return is_hs==1?cnty_grp.get(id).get(dd.hs4_code)[0][flag]>0?color_map(flag,m,cnty_grp.get(id).get(dd.hs4_code)[0][flag]):"#dddddd":"#dddddd";
            }); 
            
            //legend
            d3.select(`#${flag}_linear-gradient`).selectAll("stop").remove();
            d3.select(`#${flag}_linear-gradient`).selectAll("stop")
              .data(linearGradient_data([0,1,m/2,m],flag))//----2
              .enter()
              .append("stop")
              .attr("offset", d => d.offset)
              .attr("stop-color", d => d.color);
            d3.select(`#${flag}_lg_axis`).call(lg_axisBottom([0,m/100000000]));//----3
            
            break;
            
            case flag: cells.attr("fill",dd=>{
              return dd[flag]==0?"#dddddd":color_map(flag,domain_max[flag],flag=='hs'?dd.hs8_count:dd[flag])
            });
            break;
            
            case 'mso'://地图鼠标离开
              cells.attr("fill",d=>d[flag]==0?"#dddddd":color_map(flag,domain_max[flag],d[flag]));
              //legend
              d3.select(`#${flag}_linear-gradient`).selectAll("stop").remove();
              d3.select(`#${flag}_linear-gradient`).selectAll("stop")
                .data(linearGradient_data([0,1,domain_max[flag]/2,domain_max[flag]],flag))//----2
                .enter()
                .append("stop")
                .attr("offset", d => d.offset)
                .attr("stop-color", d => d.color);
              d3.select(`#${flag}_lg_axis`).call(lg_axisBottom([0,domain_max[flag]/100000000]));//----3
            break;
            default:null;  
          };
        };
        
      //tooltip
        function tooltip_display(s,last_c,flag,d) {
          tooltip.attr('style',`border-color:${color_range[flag][1]};`)//background-color::${color_range[flag][1]
          switch (s) {
              case 'cell':
                if (flag=='hs'|| last_c.slice(0,1)=='n') {
                  tip_title.html(`<span style='font-weight:bold'>    ${d.hs2_name}</span><br>`);
                  tip_subtitle.html(d.hs4_code<1000?`HS 0${d.hs4_code}. ${d.hs4_name}<br>`:`HS ${d.hs4_code}. ${d.hs4_name}<br>`);
                  tip_info.html(flag=='hs'?`共 ${d.hs8_count} 个HS8编码`:`${flag_set[flag]} ${simplifyNum(d[flag])}元`);
                }
                else {
                  //console.log(is_clicked,last_c);
                  tip_title.html(last_c.slice(0,1)=='w'?`贸易国/地区:<span style='font-weight:bold'>    ${pr_cnty.find(el=>el.ISO_N3==last_c.slice(1)).country_name}</span><br>`:last_c.slice(0,1)=='c'?`<span style='font-weight:bold'>    ${pr_cnty.find(el=>el.province_code==last_c.slice(1)).province_name}</span><br>`:`<span style='font-weight:bold'>    ${d.hs2_name}</span><br>`)//`省/市/自治区:`);
                  
                  tip_subtitle.html(d.hs4_code<1000?`HS 0${d.hs4_code}. ${d.hs4_name}<br>`:`HS ${d.hs4_code}. ${d.hs4_name}<br>`);
                  
                  tip_info.html(last_c.slice(0,1)=='w'?(cnty_grp.get(last_c.slice(1)).get(d.hs4_code)?`${flag_set[flag]} ${simplifyNum(cnty_grp.get(last_c.slice(1)).get(d.hs4_code)[0][flag])}元`:`${flag_set[flag]}: 0元`):last_c.slice(0,1)=='c'?(pr_grp.get(last_c.slice(1)).get(d.hs4_code)?`${flag_set[flag]} ${simplifyNum(pr_grp.get(last_c.slice(1)).get(d.hs4_code)[0][flag])}元`:`${flag_set[flag]}: 0元`):`${flag_set[flag]} ${simplifyNum(d[flag])}元`);
                // last_c需考虑2种地图，和3种数据，用is_click\map_flag\last_c,选择d[flag],cnty_grp/pr_grp.get(last_c).get(d.hs4_code)[0][flag]中的一种
                }
                tooltip.style("display",null);
              break;
              case 'm_cn':
              //cn
                //console.log(p_c_grp.get(d.properties.id).get(last_c.slice(1)))
                //flag=flag=='hs'?'ie':flag;
                tip_title.html(last_c.slice(0,1)=='w'?`贸易国/地区: <span style='font-weight:bold'>    ${p_c_cgrp.get(last_c.slice(1))[0].country_name}</span><br>`:`<span style='font-weight:bold'>    ${d.properties.name}</span><br>`)//`省/市/自治区:`);
                
                tip_subtitle.html(flag=='hs'?'':last_c.slice(0,1)=='b'?(last_c.slice(1)<1000?`HS 0${last_c.slice(1)}. ${hs4_grp.get(last_c.slice(1))[0].hs4_name}<br>`:`HS ${last_c.slice(1)}. ${hs4_grp.get(last_c.slice(1))[0].hs4_name}<br>`):last_c.slice(0,1)=='w'?`${d.properties.name}<br>`:'')//`${d.properties.name}`);
                
                tip_info.html(flag=='hs'?`进出口HS4商编：${pr_hs4_count.get(d.properties.id)[0].hs4_count}个`:last_c.slice(0,1)=='b'?pr_grp.get(d.properties.id).get(last_c.slice(1))?`${flag_set[flag]}: ${simplifyNum(pr_grp.get(d.properties.id).get(last_c.slice(1))[0][flag])}元`:`${flag_set[flag]}: 0元`:last_c.slice(0,1)=='w'?p_c_grp.get(d.properties.id).get(last_c.slice(1))?`${flag_set[flag]}: ${simplifyNum(p_c_grp.get(d.properties.id).get(last_c.slice(1))[0][flag])}元`:`${flag_set[flag]}: 0元`:`${flag_set[flag]}: ${simplifyNum(pr_id_grp.get(d.properties.id)[0][flag])}元`);
                
                tooltip.style("display",null);
              break;
              case 'm_w':
              //w
                //console.log(last_c)
                //flag=flag=='hs'?'ie':flag;
                tip_title.html(last_c.slice(0,1)=='c'?`<span style='font-weight:bold'>${p_c_pgrp.get(last_c.slice(1))[0].province_name}</span><br>`:`贸易国/地区:<span style='font-weight:bold'>    ${pr_cnty.find(el=>el.ISO_N3==d.properties.ISO_N3).country_name}</span><br>`);
                
                tip_subtitle.html(flag=='hs'?'':last_c.slice(0,1)=='b'?(last_c.slice(1)<1000?`HS 0${last_c.slice(1)}. ${hs4_grp.get(last_c.slice(1))[0].hs4_name}<br>`:`HS ${last_c.slice(1)}. ${hs4_grp.get(last_c.slice(1))[0].hs4_name}<br>`):last_c.slice(0,1)=='c'?`贸易国/地区:<span style='font-weight:bold'>    ${pr_cnty.find(el=>el.ISO_N3==d.properties.ISO_N3).country_name}</span><br>`:'')//`${pr_cnty.find(el=>el.ISO_N3==d.properties.ISO_N3).country_name}<br>`);
                
                tip_info.html(flag=='hs'?`进出口HS4商编：${cnty_hs4_count.get(d.properties.ISO_N3)[0].hs4_count}个`:last_c.slice(0,1)=='b'?cnty_grp.get(d.properties.ISO_N3).get(last_c.slice(1))?`${flag_set[flag]}: ${simplifyNum(cnty_grp.get(d.properties.ISO_N3).get(last_c.slice(1))[0][flag])}元`:`${flag_set[flag]}: 0元`:last_c.slice(0,1)=='c'?p_c_grp.get(last_c.slice(1)).get(d.properties.ISO_N3)?`${flag_set[flag]}: ${simplifyNum(p_c_grp.get(last_c.slice(1)).get(d.properties.ISO_N3)[0][flag])}元`:`${flag_set[flag]}: 0元`:`${flag_set[flag]}: ${simplifyNum(cnty_id_grp.get(d.properties.ISO_N3).slice(-1)[0][flag])}元`);
                
                tooltip.style("display",null);
              break;
              default:
                s=s?s:null;
                last_c=last_c?last_c:null
                //flag=flag=='hs'?'ie':flag;
                d=d?d:null;
                //console.log(s,last_c,flag,d)
                tip_title.html(flag=='hs'?`<span style='font-weight:bold'>HS商品编码数量</span><br>`:`<span style='font-weight:bold'>2022年1-9月 ${flag_set[flag]}</span><br>`);
                tip_subtitle.html(flag=='hs'?`<span style='font-weight:bold'>HS2(章)：</span>98<br><br>
                <span style='font-weight:bold'>HS4(4位商编)：</span>${hs4_data.map(d=>d.hs4_code).length}<br><br>
                <span style='font-weight:bold'>HS6(6位商编)：</span>5618<br><br>
                <span style='font-weight:bold'>HS8(8位商编)：</span>${d3.sum(hs4_data.map(d=>d.hs8_count))}<br><br>`
                :`<span style='font-weight:bold'>HS商品编码：</span>章:98. HS4商编:${[hs4_data.filter(d=>d[flag]>0).map(d=>d.hs4_code)][0].length}个. HS8商编:${d3.sum(hs4_data.filter(d=>d[flag]>0).map(d=>d.hs8_count))}个<br><br>
                <span style='font-weight:bold'>贸易国/地区：</span> ${cnty_tmp.filter(d=>d[flag]>0).length}个<br>`)
                tip_info.html(flag=='hs'?`<span style='font-size:12px; color: #aaa'>1.移动鼠标查看相关信息。<br>2.点击下方图例，切换视图。<br>3.在进出口视图点击小方块或地图进行锁定，并移动鼠标查看信息。</span>`:`<span style='font-weight:bold'>${flag_set[flag]}总值：</span> ${simplifyNum(d3.sum(pr_hs_grp.get('0').map(d=>d[flag])))}元`)
                                
                                
              //null;
          }
          
        }
        function tooltip_display_c(last_c,flag) {
          switch (true) {
              case last_c.slice(0,1)=='b':
                tip_title.html(`<span style='font-weight:bold'>    ${hs4_grp.get(last_c.slice(1))[0].hs2_name}</span><br>`);
                tip_subtitle.html(last_c.slice(1)<1000?`HS 0${last_c.slice(1)}. ${hs4_grp.get(last_c.slice(1))[0].hs4_name}<br>`:`HS ${last_c.slice(1)}. ${hs4_grp.get(last_c.slice(1))[0].hs4_name}<br>`);
                tip_info.html(flag=='hs'?`共 ${hs4_grp.get(last_c.slice(1))[0].hs8_count} 个HS8编码`:`${flag_set[flag]} ${simplifyNum(hs4_grp.get(last_c.slice(1))[0][flag])}元`);
                tooltip.style("display",null);  
              break;
              case last_c.slice(0,1)=='c':
                //flag=flag=='hs'?'ie':flag;
                tip_title.html(`<span style='font-weight:bold'>    ${pr_id_grp.get(last_c.slice(1))[0].province_name}</span><br>`)
                tip_subtitle.html('')//`${d.properties.name}`);
                tip_info.html(`${flag_set[flag]}: ${simplifyNum(pr_id_grp.get(last_c.slice(1))[0][flag])}元`);
                tooltip.style("display",null);
              break;
              case last_c.slice(0,1)=='w':
                //flag=flag=='hs'?'ie':flag;
                tip_title.html(`贸易国/地区:<span style='font-weight:bold'>    ${cnty_id_grp.get(last_c.slice(1))[0].country_name}</span><br>`);
                tip_subtitle.html('')
                tip_info.html(`${flag_set[flag]}: ${simplifyNum(cnty_id_grp.get(last_c.slice(1)).slice(-1)[0][flag])}元`);
                tooltip.style("display",null);
              break;
              default:
                last_c=last_c?last_c:null
                //flag=flag=='hs'?'ie':flag;
                //console.log(s,last_c,flag,d)
                tip_title.html(flag=='hs'?`<span style='font-weight:bold'>HS商品编码数量</span><br>`:`<span style='font-weight:bold'>2022年1-9月 ${flag_set[flag]}</span><br>`);
                tip_subtitle.html(flag=='hs'?`<span style='font-weight:bold'>HS2(章)：</span>98<br><br>
                  <span style='font-weight:bold'>HS4(4位商编)：</span>${hs4_data.map(d=>d.hs4_code).length}<br><br>
                  <span style='font-weight:bold'>HS6(6位商编)：</span>5618<br><br>
                  <span style='font-weight:bold'>HS8(8位商编)：</span>${d3.sum(hs4_data.map(d=>d.hs8_count))}<br><br>`
                  :`<span style='font-weight:bold'>HS商品编码：</span>章:98. HS4商编:${[hs4_data.filter(d=>d[flag]>0).map(d=>d.hs4_code)][0].length}个. HS8商编:${d3.sum(hs4_data.filter(d=>d[flag]>0).map(d=>d.hs8_count))}个<br><br><span style='font-weight:bold'>贸易国/地区：</span> ${cnty_tmp.filter(d=>d[flag]>0).length}个<br>`)
                tip_info.html(flag=='hs'?`<span style='font-size:12px; color: #aaa'>1.移动鼠标查看相关信息。<br>2.点击下方图例，切换视图。<br>3.在进出口视图点击小方块或地图进行锁定，并移动鼠标查看信息。</span>`:`<span style='font-weight:bold'>${flag_set[flag]}总值：</span> ${simplifyNum(d3.sum(pr_hs_grp.get('0').map(d=>d[flag])))}元`)
                              //tooltip.style("display",'none');
          }
          
        };
          

        }); //map_cn_data   
        }); //map_w_data
        }); //province_country
        }); //provinces_data
        }); //country_data
        }); //hs_data
        
        function simplifyNum(number) {
            if (!number && number != 0) return number;
            var str_num
            if (number >= 1E4 && number < 1E8) {
                str_num = d3.format(',.2f')(number / 1E4)
                return str_num + ' 万'
            //} else if (number >= 1E6 && number < 1E8) {
            //    str_num = d3.format(',.2f')(number / 1E6)
            //    return str_num + ' 百万'
            } else if (number >= 1E8 && number < 1E12) {
                str_num = d3.format(',.2f')(number / 1E8)
                return str_num + ' 亿'
            //} else if (number >= 1E10 && number < 1E12) {
            //    str_num = d3.format(',.2f')(number / 1E10)
            //    return str_num + ' 百亿'
            } else if (number >= 1E12) {
                str_num = d3.format(',.2f')(number / 1E12)
                return str_num + ' 万亿'
            } else { //一千以下
                return number
            }
        }
        //console.log(simplifyNum(432423423))

</script>

</body>

</html>
