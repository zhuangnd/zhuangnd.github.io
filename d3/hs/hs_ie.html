<!DOCTYPE html>

<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width" />
    <title>hs</title>
    <script type="text/javascript" src="../js/d3.v7.min.js"></script>
    <script type="text/javascript" src="legend.js"></script>

    <style>

        .axis path  {
            stroke: none;
        }
        .axis line  {
            stroke: #aaa;
        }
        .axis text  {
            fill: #aaa;
        }
        .legend line {
          stroke: #aaa;
        }
        .legend text  {
            fill: #aaa;
            font-weight: 300;
        }
        path {
            
            stroke: #aaa;
            stroke-width: .5px;
        }
        

    </style>
</head>

<body>

  <div style="width: 1408px;font-family: sans-serif;">
    <div style = "background-color: #E4E5E6; padding: 20px; color: #78909c; position: relative;"> 
      <text style = "font-size: 24px; line-height:1"> <span style = "font-weight: bold">HS</span>商品编码及进出口 <span style = "font-size:12px; color: #c2c2c2";><a style = " font-size: 13px; font-weight: 300; color: #78909c" href="mailto:zhuangnd@me.com">By @zhuangnd</a>（数据来源：海关总署网站）</span></text>
    </div>
 
   <div style = "flex: 1;margin-top: 2px; position: absolute; left:0px;background-color: #f5f5f5; padding: 0px; border: 8px solid white" id = "chart">
   </div>
   <div style = "flex: 1;margin-top: 2px; position: absolute; left:908px;background-color: #f5f5f5; padding: 0px; border: 8px solid white" id = "worldmap">
   </div>
   <div style = "flex: 1;margin-top: 2px; position: absolute; left:908px;top:450px;background-color: #f5f5f5; padding: 0px; border: 8px solid white" id = "cnmap">
   </div>
   
   <div id = "legend" style = "position: absolute; top:700px;left:100px;margin: 20px 0px 0px 10px;font-size:12px;width:auto; " >
   </div> 
   <div id = "map_info" style = "flex: 0.1; background-color: #E4E5E6; padding: 5px; color: #78909c; font-size: 12px; opacity:0;position: absolute;">
   
  </div>
   <div id = "tooltip" style = "flex: 0.1; background-color: #E4E5E6; padding: 5px; color: #78909c; font-size: 12px; opacity:0;position: absolute;width:400px;top:400px;left:300px">
       <span id = "tip_hs2" style = "font-weight: bold"></span><br><br>
       <span id = "tip_hs4"></span><br><br>
       <span id = "tip_flag" ></span>
       <span id = "tip_info" style = "font-weight: bold"> </span>   
       <span id = "tip_add"></span>    
   </div>
  </div>
<script type="text/javascript">
    var width = 900, height = 750;
    var margin = ({top: 50, right: 50, bottom: 50, left: 50})
    var tooltip = d3.select("#tooltip");
    var map_info = d3.select("#map_info");    


    d3.csv("hs_ie_202201-09.csv").then(
		function(data){
		    hs_data = data;//d3.sort(data,(a,b)=>b.name-a.name);
      d3.csv("country.csv").then(
      function(data){
        country_data = data;
      d3.csv("provinces.csv").then(
      function(data){
        province_data = data//.filter(d=>d.hs_code<5000);
      d3.json("world_605kb.json").then(
      function(data){
        map_w_data=data.features;
      d3.json("china.json").then(
      function(data){
        map_cn_data=data.features;
        
        hs4_data=d3.group(hs_data,d=>d.hs4_code);
        data_w_set = {ie:country_data.filter(el=>el.flag == 'ie'),e:country_data.filter(el=>el.flag == 'e'),i:country_data.filter(el=>el.flag == 'i')};
        data_cn_set = {ie:province_data.filter(el=>el.flag == 'ie'),e:province_data.filter(el=>el.flag == 'e'),i:province_data.filter(el=>el.flag == 'i')};
        data_w_0_set = {ie:country_data.filter(el=>el.flag == 'ie' && el.hs_code == 0),e:country_data.filter(el=>el.flag == 'e' && el.hs_code == 0),i:country_data.filter(el=>el.flag == 'i' && el.hs_code == 0)};
        data_cn_0_set = {ie:province_data.filter(el=>el.flag == 'ie' && el.hs_code == 0),e:province_data.filter(el=>el.flag == 'e' && el.hs_code == 0),i:province_data.filter(el=>el.flag == 'i' && el.hs_code == 0)};
        
        
      //参数初始化    
        var is_clicked=0;  
        var flag ='ie';//0:export,1:import,2:hs_count          
        var i_max = d3.max(hs_data.map(d=>parseFloat(d.hs4i)));
        var e_max = d3.max(hs_data.map(d=>parseFloat(d.hs4e)));
      

        color_map=(ie_,max,x)=>{
          return d3.scaleSqrt([0,1,max/2, max], ({ie:["#dddddd","#e0edd4","#59a14f","#38571a"],i:[ "white","#caf0fe","#008cb4","#00364a"],e:[ "white","#ffdad8","#ff4013","#5c0700"]})[ie_])(x);
        }
      
      //draw chart
        var svg = d3.select("#chart").append("svg")
            .attr("width", width)
            .attr("height", height)
            //.attr("preserveAspectRatio", "xMidYMid")
            //.attr('transform', 'translate(50, 100)')
            .attr("viewBox", "0 0 " + (width) + " " + (height));

        x = d3.scaleLinear()
          .domain([1,100])
          .range([margin.left, width - margin.right]);
        y = d3.scaleLinear()
          .domain([1,85])
          .range([margin.top, height - margin.bottom]);  
           
        xAxis = svg.append("g")
          .attr("class","x axis")
          .attr("transform", `translate(${height/200-1},${margin.top-height/100})`)
          .call(d3.axisTop(x).ticks(10).tickSizeOuter(0))
          .append("text")
          .text("HS1-2 ⇢")
          .attr("transform", `translate(${margin.left+20},0)`);

        yAxis = svg.append("g")
          .attr("class","y axis")
          .attr("transform", `translate(${margin.left},${height/200-1})`)
          .call(d3.axisLeft(y).ticks(10).tickSizeOuter(0))
            .append("text")
            .text("HS3-4 ⇣")
            .attr("transform", `translate(-5,${margin.top+15})`);
            
        cells = svg.append("g")
          .selectAll("rect")
          //.data(hs_data)
          .data(hs4_data)
          .enter()
          .append("rect")
          .attr("class","cells")
          .attr("height",height/100-2)
          .attr("width", width/100-2);
            
        cells.attr("fill",(d,i)=>color_map('ie',169,hs_data.filter(e=>e.hs2_code==d[1][0].hs2_code).length))
          .attr("x",d => x(d[1][0].hs2_code))
          .attr("y",margin.top)
          .transition()
          .delay(d=>y(d[1][0].hs4_code%100)*2)//逐行显示 配合attr("y",margin.top)首行
          //.delay(d=>y(d[1][0].hs2_code)*5)//逐列显示 配合attr("x",margin.left)首列
          //.delay((d,i)=>y(i*5))//逐点显示
          .duration(300)
          //.attr("x",d => x(d[1][0].hs2_code))
          .attr("y",d => y(d[1][0].hs4_code%100))
          .attr("fill",d=>color_map('ie',169,d[1].length));
           
      //draw world map
        var proj = d3.geoMercator().center([0, 40]).scale(70).translate([(1400-width) / 2, height / 4+30]);
        var path = d3.geoPath().projection(proj);
        
        var map_w_svg = d3.select("#worldmap").append("svg")
          .attr("width", 1400-width)
          .attr("height", height/2-2)
          .attr("transform", `translate(0,0)`)
          .attr("viewBox", "0 0 " + (1400-width) + " " + height/2);
        
        var country = map_w_svg.append("g")
          .selectAll("path")
          .data(map_w_data)
          .enter()
          .append("path")
          .attr("d", path)
          .attr("fill","#dddddd")
          .attr("class", "countries");
          
         /*       
        country.on("click",function(){
          //d3.selectAll("path").style("fill","#ddd");
          //d3.select(this).style("fill","#008cb4")
        })
        country.on("mouseover", function (e,d) {
          d3.select(this).attr("fill","#008cb4")
          map_info.style("display", null)
            .style("left",(e.pageX)+"px")
            .style("top",(e.pageY-15)+"px");
                    //console.log(d);
              map_info.text(`${d.properties.NAME}`);
                })
        country.on("mouseout", function () {
          d3.selectAll(".countries").attr("fill","#dddddd")
          map_info.style("display", "none")
                });
           */
                
      //draw china map
        var proj_cn = d3.geoMercator().center([105, 38]).scale(400).translate([(1400-width) / 2, height / 4]);
        var path_cn = d3.geoPath().projection(proj_cn);
        
        var map_cn_svg = d3.select("#cnmap").append("svg")
          .attr("width", 1400-width)
          .attr("height", height/2-3)
          .attr("transform", `translate(0,0)`)
          .attr("viewBox", "0 0 " + (1400-width) + " " + height/2);
        
        var province = map_cn_svg.append("g")
          .selectAll("path")
          .data(map_cn_data)
          .enter()
          .append("path")
          .attr("d", path_cn)
          .attr("fill","#dddddd")
          
          .attr("class", "provinces");

         /*       
        province.on("click",function(){
          //d3.selectAll("path").style("fill","#ddd");
          //d3.select(this).style("fill","coral")
        })
        province.on("mouseover", function (e,d) {
          d3.select(this).attr("fill","#ff4013");
          map_info.style("display", null)
            .style("left",(e.pageX)+"px")
            .style("top",(e.pageY-15)+"px");
          map_info.text(`${d.properties.name}`);
                })
        province.on("mouseout", function () {
          d3.selectAll(".provinces").attr("fill","#dddddd");
          map_info.style("display", "none");
                });
           */     
      //draw chart legend
        legend_svg=d3.select("#legend").append("svg")
           .attr("width", 800)
           .attr("height", 50);
        
        hs8_legend=legend_svg.append("g").attr("class","legend");
        e_legend=legend_svg.append("g").attr("class","legend").attr('transform', 'translate(150, 0)');
        i_legend=legend_svg.append("g").attr("class","legend").attr('transform', 'translate(300, 0)');
        blank_legend=legend_svg.append("g").attr("class","legend").attr('transform', 'translate(450, 0)');
        
        d3.selectAll(".legend")
           .on("mouseover",function(){d3.select("body").style("cursor","pointer");})
           .on("mouseleave",function(){d3.select("body").style("cursor",null);})
           .append("title")
           .text("点击显示");
        
        l_hs8 = legend(d3.scaleSqrt([1,85, 169], ["#d6d6d6","#59a14f","#38571a"]),hs8_legend,{tx:0,ty:0,title:"HS8数量",width:100,height:45,tickValues : [1,85,169]});  
        l_e = legend(d3.scaleSqrt([1,e_max/2, e_max], [ "#ffdad8","#ff4013","#5c0700"]),e_legend,{tx:0,ty:0,title:"HS4出口(亿元)",width:100,height:45,tickValues : [0,5000,e_max],tickFormat:",f"}); //".0f"
        l_i = legend(d3.scaleSqrt([1,i_max/2, i_max], ["#caf0fe","#76b7b2","#00364a"]),i_legend,{tx:0,ty:0,title:"HS4进口(亿元)",width:100,height:45,tickValues : [0,10000,i_max],tickFormat:",f"});
        l_blank = legend(d3.scaleSqrt([1, 1], ["#dddddd","#dddddd","#dddddd"]),blank_legend,{tx:0,ty:0,title:"空值",width:20,height:45,tickValues : [0],tickFormat:",f"}); 
         
        e_legend.on("click",function(){
            flag = 'e';
            fill_map_w('e',0);
            fill_map_cn('e',0);
            cells.transition()
               .delay(d=>y(d[1][0].hs2_code)*2)
               .duration(300)
               .attr("fill",d=>color_map('e',e_max,d[1][0].hs4e));
        });
        i_legend.on("click",function(){
            flag = 'i';
            fill_map_w('i',0);
            fill_map_cn('i',0);
            cells.transition()
                .delay(d=>y(d[1][0].hs2_code)*2)
                .duration(300)
                .attr("fill",d=>color_map('i',i_max,d[1][0].hs4i));
         }); 
        hs8_legend.on("click",function(){
            flag = 'ie';
            fill_map_w('ie',0);
            fill_map_cn('ie',0);
            cells
                .attr("y",margin.top)
                .transition()
                .delay(d=>y(d[1][0].hs4_code%100)*2)
                .duration(300)
                .attr("y",d => y(d[1][0].hs4_code%100))
                .attr("fill",d=>color_map('ie',169,d[1].length))
         });
         
      
      //tooltip
        var tooltip = d3.select("#tooltip"); 
        var tip_hs2 = d3.select("#tip_hs2");
        var tip_hs4 = d3.select("#tip_hs4"); 
        var tip_flag = d3.select("#tip_flag"); 
        var tip_info = d3.select("#tip_info");
        var tip_add = d3.select("#tip_add"); 
        
             
        cells.on("mouseover touchstart",function (e,d){    //(e,d)=>{},箭头函数下,d3.select(this)无效出错
            console.log(flag,is_clicked,d[0]);
            tip_hs2.text(`${d[1][0].hs2_name}`);
            tip_hs4.text(d[1][0].hs4_code<1000?`HS 0${d[1][0].hs4_code}. ${d[1][0].hs4_name}`:`HS ${d[1][0].hs4_code}. ${d[1][0].hs4_name}`);
            tip_flag.text(flag=='e'?'出口 ':flag=='i'?'进口 ':'共');
            tip_info.text(flag=='e'?` ${d3.format(",.2f")(parseFloat(d[1][0].hs4e))} `:flag=='i'?` ${d3.format(",.2f")(parseFloat(d[1][0].hs4i))} `:` ${d[1].length} `);
            tip_add.text(flag=='ie'?' 个HS8编码':' 亿元');
            tooltip
                .style("display",null)
                .style("opacity",1);
            
            is_clicked==0?fill_map_w(flag, flag=='ie'?0:d[0]):null;
            is_clicked==0?fill_map_cn(flag, flag=='ie'?0:d[0]):null;
            /*
            country.attr("fill",dd=>{
              data = country_data.filter(el=>el.flag == 'i_hs4')
              return data.filter(el=>el.ISO_N3==parseFloat(dd.properties.ISO_N3)).map(f=>f.hs_code).indexOf(d[0])>-1?color_i(data.filter(e=>e.hs_code==d[0] && e.ISO_N3==parseFloat(dd.properties.ISO_N3))[0].rmb):"white";
              });
            province.attr("fill",dd=>{
              data = province_data.filter(el=>el.flag == 'e_hs4')
              return data.filter(el=>el.province_code==parseFloat(dd.properties.id)).map(f=>f.hs_code).indexOf(d[0])>-1?color_e(data.filter(e=>e.hs_code==d[0] && e.province_code==dd.properties.id)[0].rmb):"white";
            })
            */
          })
          .on("mouseleave touchmove",function (e,d) {
            is_clicked==0?fill_map_w(flag, 0):null;
            is_clicked==0?fill_map_cn(flag, 0):null;
            
            tooltip
                .style("opacity",0)
                .style("display","none");
          })
          .on("click",function (e,d) {
              d3.selectAll(".cells").style("stroke","none");
              d3.select(this).style("stroke",d=>{return is_clicked==0?'#e15759':"none";});
              is_clicked==0?is_clicked=1:is_clicked=0;
              
              /*
              country.transition()
                .duration(500)
                .delay(500)
                .attr("fill",dd=>{
                  data=country_data.filter(el=>el.flag == 'i');
                  return data.filter(el=>el.ISO_N3==parseFloat(dd.properties.ISO_N3)).map(f=>f.hs_code).indexOf(d[0])>-1?color_map('i',d3.max(data.filter(e=>e.hs_code==d[0]).map(f=>parseFloat(f.rmb))),data.filter(e=>e.hs_code==d[0] && e.ISO_N3==parseFloat(dd.properties.ISO_N3))[0].rmb):'white';
                })
                */
          })
          
        province.on("mouseover touchstart", function (e,d) {  
            //console.log(flag,is_clicked,d.properties.id);
            flag=='ie'?null:fill_cell_cn(flag,d.properties.id) ;
          })
          .on("mouseout touchmove",function (e,d) {
            cells.attr("fill",d=>flag=='ie'?color_map('ie',169,d[1].length):color_map(flag,e_max ,d[1][0].hs4e));
          })
        ;
        country.on("mouseover touchstart", function (e,d) {  
            //console.log(flag,is_clicked,d.properties.id);
            flag=='ie'?null:fill_cell_w(flag,d.properties.ISO_N3) ;
          })
          .on("mouseout touchmove",function (e,d) {
            cells.attr("fill",d=>flag=='ie'?color_map('ie',169,d[1].length):color_map(flag,e_max ,d[1][0].hs4e));
          })
        ; 
         
        
      //update
      
      
        fill_map_w('ie',0);
        fill_map_cn('ie',0);
                
        function fill_map_w(flag,hs) {
          country
            //.transition()
            //.duration(500)
            .attr("fill",dd=>{
            data = data_w_set[flag].filter(el=>el.hs_code==hs);
            v_max = d3.max(data_w_0_set[flag].map(f=>parseFloat(f.rmb)));
              return data.filter(el=>el.ISO_N3==parseFloat(dd.properties.ISO_N3)).length>0?color_map(flag,v_max,data.filter(e=>parseFloat(e.ISO_N3)==parseFloat(dd.properties.ISO_N3))[0].rmb):"#dddddd";
            })
        };
        function fill_map_cn(flag,hs) {
          province
            //.transition()
            //.duration(500)
            .attr("fill",dd=>{
            data = data_cn_set[flag].filter(el=>el.hs_code==hs);
            v_max = d3.max(data_cn_0_set[flag].map(f=>parseFloat(f.rmb)));
              return data.filter(el=>el.province_code==parseFloat(dd.properties.id)).length>0?color_map(flag,v_max,data.filter(e=>parseFloat(e.province_code)==parseFloat(dd.properties.id))[0].rmb):"#dddddd";
          })
        };  
        function fill_cell_cn(flag,id) {
          cells
            //.transition()
            //.duration(300)
            .attr("fill",dd=>{
            data = data_cn_set[flag].filter(el=>el.province_code==id);
            //console.log(data.filter(el=>el.hs_code==0)[0].rmb);
            //value = data.filter(el=>el.hs_code==dd.hs4_code);
              return data.filter(el=>el.hs_code==dd[0]).length>0?color_map(flag,d3.max(data.map(f=>parseFloat(f.rmb))),data.filter(el=>el.hs_code==dd[0])[0].rmb):"#dddddd";
          })
        };
        function fill_cell_w(flag,id) {
          cells
            //.transition()
            //.duration(300)
            .attr("fill",dd=>{
            data = data_w_set[flag].filter(el=>el.ISO_N3==id);
            //console.log(data.filter(el=>el.hs_code==0)[0].rmb);
            //value = data.filter(el=>el.hs_code==dd.hs4_code);
              return data.filter(el=>el.hs_code==dd[0]).length>0?color_map(flag,d3.max(data.map(f=>parseFloat(f.rmb))),data.filter(el=>el.hs_code==dd[0])[0].rmb):"#dddddd";
          })
        };    
             
        //d3.selectAll("body").on("click",d=>cells.style("stroke","none"));

        }); //map_cn_data   
        }); //map_w_data
        }); //provinces_data
        }); //country_data
        }); //hs_data

</script>

</body>

</html>