<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1,maximum-scale=1"/>
    <title>site_flow</title>
    <script type="text/javascript" src="d3.min.js"></script>

    <style>
		#tooltip_1 {
			position: absolute;
			width: auto;
			height:auto;
			color:dimgray;
			left:10px;
			top:300px;
			}
	
		#tooltip_1 table {
			margin: 2px;
			font-family: 微软雅黑;
			font-size: 12px;
			line-height: 14px;
			}
		.Decl_Quality_Sites {
			position: absolute;
			width: auto;
			height:auto;
			color:dimgray;
			}	
		.declport_rect {
			fill:#eee;
			opacity:0.5;
			}
		.total_rect {
			fill:#eee;
			opacity:0.5;
			}
		.ieport_rect {
			fill:#eee;
			opacity:0.5;
			}
		.mycircle_I,.ieport_rect_i,.declport_rect_i {
			fill:salmon;
			opacity:0.8;
			stroke:salmon;
            stroke-width: 0.5px;	
			}
		.mycircle_E,.ieport_rect_e,.declport_rect_e {
			fill:steelblue;
			opacity:0.8;
			stroke:steelblue;
            stroke-width: 0.5px;
			}
		.mycircle_24 {
			fill:none;
			opacity:0.9;
			}
		.mytext,.Legendtext {
			font-family: sans-serif;
			font-size: 12px;
			line-height: 12px;
			fill: #bbb;	
			}
    </style>
</head>

<body>
	<div id="tooltip_1" class="tooltip">	
    <table>
      <thead class="info_title">
        <tr>
          <th><span id="ccus"></span><span id="cmon"></span></th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        <tr class='Time_Start'>
          <td>自 <span id="Time_Start_3700"> </span></td>
        </tr>
        <tr class='Decl_Time'>
          <td>至 <span id="Decl_Time_3700"> </span></td>
        </tr>
        <tr class='Decl_Time_2'>
          <td><span id="Decl_Time_2_3700"> </span></td>
        </tr>
        <tr class='Decl_Quality'>
          <td>申报 <span id="Decl_Quality_3700">0</span> 份报关单</td>
        </tr>
      </tbody>
    </table>
	</div>
	
	<div id="svg_div" class="svg_div">	

	</div>
	<script type="text/javascript">
		var width = screen.width>screen.height?screen.height:screen.width,
		height = screen.height,
		rect_width = width/9,
		rect_height = (height-200) / 48,
		rect_padding_h = (height-200) / 48,
		rect_padding_w = 10,
		mydelay = 150,
		mydrt = 1500
		;
		console.log(rect_height);
		var sitesi = [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24],
		sitesd = [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24],
		sitese = ['3702','3703','3704','3705','3706','3707','3708','3709','3710','3711','3712','3713','3714','3715','3716','3717','3718','3720','3722','3723','3724','3725','3726','0000'],
		sitesc = ['泉刺桐办','漳州海关','东山海关','泉石狮办','龙岩海关','泉肖厝办','海沧港区','海沧保税','厦高崎办','东渡海关','海沧海关','厦驻邮办','象屿保税','机场海关','厦集同办','厦物流园','泉综保区','厦门物流','大嶝监管','泉晋江办','邮轮办','厦翔安办','泉陆地港','外关区']
		;
		var wk = ["周日","周一","周二","周三","周四","周五","周六"];
		var dates = ["2018年10月28日 ", "2018年10月29日 ", "2018年10月30日 ", "2018年10月31日 ", "2018年11月1日 ", "2018年11月2日 ", "2018年11月3日 "];	
		
		var svg = d3.select(".svg_div").append("svg")
            .attr("width", width)
            .attr("height", height)
			.attr("class","mysvg");
		
					
		var myLegend = svg.append("g")
			.attr("class","myLegend_g");
		var LegendX=10,
			LegendY=50,
			LegendPadding=15
			;
		myLegend.append("circle")
			.attr("class","myLegend mycircle_I")
			.attr("cx",LegendX)
			.attr("cy",LegendY)
			.attr("r",3);
		myLegend.append("text")
			.attr("class","Legendtext")
			.attr("x",LegendX+10)
			.attr("y",LegendY+5)
			.text("关区进口");
		myLegend.append("circle")
			.attr("class","myLegend mycircle_E")
			.attr("cx",LegendX)
			.attr("cy",LegendY+LegendPadding)
			.attr("r",3);
		myLegend.append("text")
			.attr("class","Legendtext")
			.attr("x",LegendX+10)
			.attr("y",LegendY+LegendPadding+5)
			.text("关区出口");		
		myLegend.append("circle")
			.attr("class","myLegend mycircle_I mycircle_24")
			.attr("cx",LegendX)
			.attr("cy",LegendY+LegendPadding*2)
			.attr("r",3);
		myLegend.append("text")
			.attr("class","Legendtext")
			.attr("x",LegendX+10)
			.attr("y",LegendY+LegendPadding*2+5)
			.text("外关区进口");
		myLegend.append("circle")
			.attr("class","myLegend mycircle_E mycircle_24")
			.attr("cx",LegendX)
			.attr("cy",LegendY+LegendPadding*3)
			.attr("r",3);
		myLegend.append("text")
			.attr("class","Legendtext")
			.attr("x",LegendX+10)
			.attr("y",LegendY+LegendPadding*3+5)
			.text("外关区出口");
		
		var total_g = svg.append("g")
			.attr("class","total_g")
			.attr("transform", function(d,i){return "translate(" + 0 + "," + (height  -200 - rect_height - rect_padding_h) / 2 + ")"});
			
		var total_rect = total_g
			.append("rect")
			.attr("class","total_rect")
			.attr("id","total_rect")
			.attr("width",rect_width)
			.attr("height",rect_height * 2)
			.attr("x",0)
			.attr("y",0);
						
		var ieport_g = svg.append("g")
			.attr("class","ieport_g")
			.attr("transform", function(d,i){return "translate(" + (rect_width*3) + "," + 50 + ")"});
		
		ieport_g.append("text")
			.attr("class","mytext ieport_label")
			.text("进出口岸")
			.attr("x",0)
			.attr("y",-20);
		
		var ieport_rect = ieport_g.selectAll("rect")
			.data(sitesi)
			.enter()
			.append("rect")
			.attr("class","ieport_rect")
			.attr("id",function(d,i){return "ieport_rect_" + i})
			.attr("width",rect_width)
			.attr("height",rect_height)
			.attr("x",0)
			.attr("y", function(d,i){return i*2 * rect_padding_h});
		
		var ieport_rect_i = ieport_g.selectAll(".ieport_rect_i")
			.data(sitesi)
			.enter()
			.append("rect")
			.attr("class","ieport_rect_i")
			.attr("id",function(d,i){return "ieport_rect_" + i})
			.attr("width",10)
			.attr("height",rect_height/2)
			.attr("x",rect_width-10)
			.attr("y", function(d,i){return i*2 * rect_padding_h});

		var ieport_rect_e = ieport_g.selectAll(".ieport_rect_e")
			.data(sitesi)
			.enter()
			.append("rect")
			.attr("class","ieport_rect_e")
			.attr("id",function(d,i){return "ieport_rect_" + i})
			.attr("width",10)
			.attr("height",rect_height/2)
			.attr("x",rect_width-10)
			.attr("y", function(d,i){return i*2 * rect_padding_h+rect_height/2});

						
		var declport_g = svg.append("g")
			.attr("class","ieport_g")
			.attr("transform", function(d,i){return "translate(" + (rect_width*6) + "," + 50 + ")"});
		
		declport_g.append("text")
			.attr("class","mytext declport_label")
			.text("进出口岸")
			.attr("x",0)
			.attr("y",-20);
		
		var declport_rect = declport_g.selectAll("rect")
			.data(sitesi)
			.enter()
			.append("rect")
			.attr("class","declport_rect")
			.attr("id",function(d,i){return "declport_rect_" + i})
			.attr("width",rect_width)
			.attr("height",rect_height)
			.attr("x",0)
			.attr("y", function(d,i){return i*2 * rect_padding_h});
		
		var declport_rect_i = declport_g.selectAll(".declport_rect_i")
			.data(sitesi)
			.enter()
			.append("rect")
			.attr("class","declport_rect_i")
			.attr("id",function(d,i){return "declport_rect_" + i})
			.attr("width",10)
			.attr("height",rect_height/2)
			.attr("x",rect_width-10)
			.attr("y", function(d,i){return i*2 * rect_padding_h});

		var declport_rect_e = declport_g.selectAll(".declport_rect_e")
			.data(sitesi)
			.enter()
			.append("rect")
			.attr("class","declport_rect_e")
			.attr("id",function(d,i){return "declport_rect_" + i})
			.attr("width",10)
			.attr("height",rect_height/2)
			.attr("x",rect_width-10)
			.attr("y", function(d,i){return i*2 * rect_padding_h+rect_height/2});
		
		var declport_text = declport_g.selectAll(".declport_text")
			.data(sitesc)
			.enter()
			.append("text")
			.attr("class","mytext declport_text")
			.attr("transform", function(d,i){return "translate(" + (rect_width+5) + "," + (i*2 * rect_padding_h+6) + ")"})
			.text(function(d){return d});
				
			
		d3.csv("3700d1.csv",function(data){
		
			var END_DATE = [];
			var DelayD = [];
						


			
			//var myslice = 10000;
			//var mydata = data.slice(0,myslice);
			var mydata = data;
			
			//var mydata = data.filter(function(e){return e.END_DATE >'2018-11-3' && e.END_DATE <'2018-11-4'}) ;
			//var mydata = data.filter(function(e){return e.I_E_PORT.slice(0,2) !== "37"}) ;////从索引号0到索引号1
			//var mydata = data.filter(function(e){return e.I_E_PORT.substr(0,2) == "37"}) ;//从索引号0开始截取2位
			//var mydata = data.filter(function(e){return e.COUNTRY == "113"});
			
			var i_length = mydata.filter(function(e){return e.I_E_FLAG == "I"}),
				e_length = mydata.filter(function(e){return e.I_E_FLAG == "E"});
			var i_length = i_length.length,	
				e_length = e_length.length;
			
			mydata.forEach(function(d){
				END_DATE.push(d.END_DATE);
				//dates.push(d.DELAY);
				});

		for (j=0;j<7;j++){
			(function(h){
				var mydata=data.filter(function(e){
					var dd=new Date(e.END_DATE);
					//dates[h]=dd.getFullYear()+"年"+(dd.getMonth()+1)+"月"+dd.getDate()+"日 ";
					return dd.getDay()==h;});
				DelayD[h]=d3.min(mydata, function(e) { return e.DELAY;});
				setTimeout(function(){
					var mydata=data.filter(function(e){var dd=new Date(e.END_DATE);return dd.getDay()==h;});
					var DELAY0=d3.min(mydata, function(e) { return e.DELAY;});
					//console.log(mydata.length);
					d3.select("#Time_Start_3700").text(dates[0] + " " + wk[0]);
					d3.select("#Decl_Time_3700").text(dates[h] + " " + wk[h]);},DelayD[h]);
				})(j)	
			};


		var circle = svg.selectAll(".mycircle")
			.data(mydata)
			//.data()
			.enter()
			.append("circle")
			.attr("class",function(d,i){return "mycircle mycircle_" + d.I_E_FLAG + " mycircle_" + (sitese.lastIndexOf(d.I_E_PORT)==-1?24:sitese.lastIndexOf(d.I_E_PORT))})
			.attr("cx",-5)
			.attr("cy",function(d){return (height  -200 - rect_height - rect_padding_h) / 2 + Math.random()*rect_height * 2})
			//.attr("transform", function(d,i){var rnd = Math.random()*rect_height;return "translate(" + (-rect_width*2 + d.sitese.lastIndexOf(d.I_E_PORT)==-1?23:sitese.lastIndexOf(d.I_E_PORT)*5) + "," + ((height - rect_height - rect_padding_h) / 2 + rnd * 2) + ")"})			
			.attr("r",2)
				.transition()//0
				//.delay(function(d,i){return d.DELAY})
				.duration(function(d,i){return d.DELAY})
				.attr("cx",-5)
				.transition()//2
				//.delay(function(d,i){return d.DELAY})
				.duration(mydrt)
				.ease("linear")
				.attr("cx",rect_width*1.5)
				.transition()//2
				//.delay(function(d,i){return d.DELAY})
				.duration(mydrt)
				.ease("linear")
				.attr("cx",rect_width*2.5)
				.attr("cy",function(d,i){return (50 + (sitese.lastIndexOf(d.I_E_PORT)==-1?23:sitese.lastIndexOf(d.I_E_PORT)) * (rect_height+rect_padding_h) + Math.random()*rect_height)})//lastIndexOf根据值查找索引号
				.transition()//3
				//.delay(function(d,i){return d.DELAY})
				.duration(mydrt)
				.ease("linear")
				.attr("cx",rect_width*4.5)
				.transition()//5
				//.delay(function(d,i){return d.DELAY})
				.duration(mydrt)
				.ease("linear")
				.attr("cx",rect_width*5.5)
				.attr("cy",function(d,i){return (50 + (sitese.lastIndexOf(d.DECL_PORT)==-1?23:sitese.lastIndexOf(d.DECL_PORT)) * (rect_height+rect_padding_h) + Math.random()*rect_height)})//lastIndexOf根据值查找索引号.transition()
				.transition()//6
				//.delay(function(d,i){return d.DELAY})
				.duration(mydrt)
				.ease("linear")
				.attr("cx",rect_width*7)
				.remove()
				;
				
			
			
		});	


	
    </script>
</body>
</html>